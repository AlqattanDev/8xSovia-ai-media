<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8xSovia AI Studio - Media Gallery</title>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #fff;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            padding: 1.5rem 2rem;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title-section {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .nav-link {
            color: rgba(255,255,255,0.6);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-link:hover {
            color: #667eea;
        }

        .stats {
            display: flex;
            gap: 2rem;
            color: rgba(255,255,255,0.6);
            font-size: 0.9rem;
        }

        /* Filters */
        .filters {
            padding: 1rem 2rem;
            background: rgba(0,0,0,0.8);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .filters-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            position: relative;
        }

        .filter-group label {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.6);
        }

        select, input[type="text"] {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.3s;
        }

        select:hover, input[type="text"]:hover {
            border-color: rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.08);
        }

        select:focus, input[type="text"]:focus {
            border-color: #667eea;
            background: rgba(102,126,234,0.1);
        }

        /* Active Filter Chips */
        .active-filters {
            padding: 0 2rem 1rem;
            background: rgba(0,0,0,0.8);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: none;
        }

        .active-filters.visible {
            display: block;
        }

        .active-filters-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .active-filters-label {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.6);
            margin-right: 0.5rem;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(102,126,234,0.15);
            border: 1px solid rgba(102,126,234,0.3);
            color: #a5b4fc;
            padding: 0.4rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .filter-chip:hover {
            background: rgba(102,126,234,0.25);
            border-color: rgba(102,126,234,0.5);
        }

        .filter-chip-remove {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 0;
            font-size: 1.1rem;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .filter-chip-remove:hover {
            opacity: 1;
        }

        .clear-all-filters {
            background: rgba(239,68,68,0.15);
            border: 1px solid rgba(239,68,68,0.3);
            color: #fca5a5;
            padding: 0.4rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-all-filters:hover {
            background: rgba(239,68,68,0.25);
            border-color: rgba(239,68,68,0.5);
        }

        /* Gallery Grid - Masonry Layout */
        .gallery {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .gallery-grid {
            column-count: 5;
            column-gap: 1.5rem;
        }

        .gallery-item {
            position: relative;
            break-inside: avoid;
            margin-bottom: 1.5rem;
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            background: linear-gradient(135deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(10px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            animation: fadeInUp 0.6s ease forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .gallery-item:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow:
                0 20px 60px rgba(0,0,0,0.5),
                0 0 40px rgba(102,126,234,0.2),
                inset 0 0 20px rgba(102,126,234,0.1);
            border-color: rgba(102,126,234,0.4);
            z-index: 10;
        }

        .gallery-item img,
        .gallery-item video {
            width: 100%;
            height: auto;
            display: block;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .gallery-item video {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            object-fit: cover;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .gallery-item.video-playing img {
            opacity: 0;
        }

        .gallery-item.video-playing video {
            opacity: 1;
        }

        .gallery-item:hover img {
            transform: scale(1.05);
        }

        .gallery-item:hover video {
            transform: scale(1.05);
        }

        .gallery-item-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                to bottom,
                rgba(0,0,0,0.7) 0%,
                rgba(0,0,0,0.3) 30%,
                rgba(0,0,0,0.3) 70%,
                rgba(0,0,0,0.9) 100%
            );
            backdrop-filter: blur(8px);
            padding: 1rem;
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .gallery-item:hover .gallery-item-overlay {
            opacity: 1;
        }

        .overlay-top {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .quick-action {
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .quick-action:hover {
            background: rgba(102,126,234,0.8);
            border-color: rgba(102,126,234,1);
            transform: scale(1.1);
        }

        .overlay-bottom {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .item-prompt {
            font-size: 0.85rem;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            margin-bottom: 0.5rem;
            color: rgba(255,255,255,0.95);
        }

        .item-meta {
            display: flex;
            justify-content: space-between;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.7);
        }

        .item-meta span {
            background: rgba(0,0,0,0.4);
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            backdrop-filter: blur(5px);
        }

        .video-badge {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Modal Viewer */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(20px);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .modal-close {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        .modal-viewer {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 4rem 2rem 8rem;
        }

        .modal-media {
            max-width: 90%;
            max-height: 90%;
        }

        .modal-media img,
        .modal-media video {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        /* Navigation arrows */
        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .nav-arrow:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-50%) scale(1.1);
        }

        .nav-arrow.prev { left: 2rem; }
        .nav-arrow.next { right: 2rem; }

        /* Modal Bottom Controls */
        .modal-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, transparent 100%);
            padding: 3rem 2rem 2rem;
        }

        .modal-prompt {
            text-align: center;
            font-size: 1rem;
            margin-bottom: 1.5rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            color: rgba(255,255,255,0.9);
        }

        .mode-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .mode-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .mode-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mode-btn:hover {
            background: rgba(255,255,255,0.15);
        }

        .mode-btn.active {
            background: #667eea;
            border-color: #667eea;
        }

        .iteration-dots {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.3s;
        }

        .dot:hover {
            background: rgba(255,255,255,0.5);
            transform: scale(1.2);
        }

        .dot.active {
            background: #667eea;
            width: 12px;
            height: 12px;
        }

        .post-counter {
            color: rgba(255,255,255,0.6);
            font-size: 0.9rem;
        }

        /* Similar Items Section */
        .similar-items {
            padding: 2rem;
            background: rgba(0,0,0,0.5);
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .similar-items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .similar-items-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: rgba(255,255,255,0.9);
        }

        .similar-items-carousel {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding: 0.5rem 0;
            scrollbar-width: thin;
            scrollbar-color: rgba(102,126,234,0.5) rgba(255,255,255,0.1);
        }

        .similar-items-carousel::-webkit-scrollbar {
            height: 6px;
        }

        .similar-items-carousel::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .similar-items-carousel::-webkit-scrollbar-thumb {
            background: rgba(102,126,234,0.5);
            border-radius: 3px;
        }

        .similar-items-carousel::-webkit-scrollbar-thumb:hover {
            background: rgba(102,126,234,0.7);
        }

        .similar-item {
            flex-shrink: 0;
            width: 120px;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
            background: rgba(0,0,0,0.3);
        }

        .similar-item:hover {
            transform: translateY(-4px);
            border-color: rgba(102,126,234,0.6);
            box-shadow: 0 8px 20px rgba(102,126,234,0.3);
        }

        .similar-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }

        .similar-item-info {
            padding: 0.5rem;
            font-size: 0.7rem;
            color: rgba(255,255,255,0.7);
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        .similar-items-loading {
            text-align: center;
            padding: 2rem;
            color: rgba(255,255,255,0.5);
        }

        .similar-items-empty {
            text-align: center;
            padding: 1rem;
            color: rgba(255,255,255,0.4);
            font-size: 0.9rem;
        }

        /* Comparison Mode */
        .compare-checkbox {
            position: absolute;
            top: 0.75rem;
            left: 0.75rem;
            width: 24px;
            height: 24px;
            cursor: pointer;
            z-index: 5;
            accent-color: #667eea;
        }

        .comparison-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(20px);
            border-top: 2px solid rgba(102,126,234,0.5);
            padding: 1rem 2rem;
            z-index: 500;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .comparison-bar.visible {
            transform: translateY(0);
        }

        .comparison-bar-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .comparison-items {
            display: flex;
            gap: 0.75rem;
            flex: 1;
            overflow-x: auto;
        }

        .comparison-item-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid rgba(102,126,234,0.5);
        }

        .comparison-actions {
            display: flex;
            gap: 0.75rem;
        }

        .compare-btn {
            background: #667eea;
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .compare-btn:hover {
            background: #7c8ef0;
            transform: translateY(-2px);
        }

        .compare-btn.secondary {
            background: rgba(255,255,255,0.1);
        }

        .compare-btn.secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        .comparison-count {
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
        }

        /* Comparison Modal */
        .comparison-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.98);
            z-index: 2000;
            overflow-y: auto;
            padding: 2rem;
        }

        .comparison-modal.active {
            display: block;
        }

        .comparison-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            max-width: 1400px;
            margin: 0 auto 2rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .comparison-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .comparison-modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            max-width: 1400px;
            margin: 0 auto 2rem;
        }

        .comparison-grid[data-columns="2"] {
            grid-template-columns: repeat(2, 1fr);
        }

        .comparison-grid[data-columns="3"] {
            grid-template-columns: repeat(3, 1fr);
        }

        .comparison-grid[data-columns="4"] {
            grid-template-columns: repeat(4, 1fr);
        }

        .comparison-grid[data-columns="5"] {
            grid-template-columns: repeat(5, 1fr);
        }

        .comparison-grid[data-columns="6"] {
            grid-template-columns: repeat(6, 1fr);
        }

        /* Masonry view mode */
        .comparison-grid[data-view-mode="masonry"] {
            display: block;
            column-count: 4;
            column-gap: 1.5rem;
        }

        .comparison-grid[data-view-mode="masonry"][data-columns="2"] {
            column-count: 2;
        }

        .comparison-grid[data-view-mode="masonry"][data-columns="3"] {
            column-count: 3;
        }

        .comparison-grid[data-view-mode="masonry"][data-columns="4"] {
            column-count: 4;
        }

        .comparison-grid[data-view-mode="masonry"][data-columns="5"] {
            column-count: 5;
        }

        .comparison-grid[data-view-mode="masonry"][data-columns="6"] {
            column-count: 6;
        }

        .comparison-grid[data-view-mode="masonry"] .comparison-cell {
            break-inside: avoid;
            margin-bottom: 1.5rem;
        }

        .comparison-cell {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            overflow: hidden;
        }

        .comparison-grid[data-view-mode="masonry"] .comparison-cell-media-container {
            aspect-ratio: unset;
            height: auto;
        }

        .comparison-grid[data-view-mode="masonry"] .comparison-cell-media,
        .comparison-grid[data-view-mode="masonry"] .comparison-cell-video {
            height: auto;
            aspect-ratio: unset;
        }

        .comparison-cell-media-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
            overflow: hidden;
            background: rgba(0,0,0,0.3);
        }

        .comparison-cell-media,
        .comparison-cell-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .comparison-cell-video {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .comparison-cell-media-container:hover .comparison-cell-video {
            opacity: 1;
        }

        .comparison-cell-media-container:hover .comparison-cell-media {
            opacity: 0;
        }

        /* When locked, the toggleComparisonMedia function handles opacity directly */
        /* No need for hover overrides - the inline styles will take precedence */

        .comparison-video-badge {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 10;
        }

        .comparison-toggle-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
            z-index: 10;
            opacity: 0;
        }

        .comparison-cell-media-container:hover .comparison-toggle-btn {
            opacity: 1;
        }

        .comparison-toggle-btn:hover {
            background: rgba(102,126,234,0.8);
            border-color: rgba(102,126,234,1);
            transform: scale(1.1);
        }

        .comparison-cell-media-container[data-locked="true"] .comparison-toggle-btn {
            opacity: 1;
            background: rgba(102,126,234,0.8);
            border-color: rgba(102,126,234,1);
        }

        .comparison-cell-info {
            padding: 1rem;
        }

        .comparison-cell-prompt {
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            color: rgba(255,255,255,0.9);
            line-height: 1.4;
        }

        .comparison-cell-meta {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.6);
        }

        .comparison-cell-meta span {
            background: rgba(255,255,255,0.05);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .comparison-table {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            overflow: hidden;
        }

        .comparison-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .comparison-table th {
            background: rgba(255,255,255,0.05);
            font-weight: 600;
            color: rgba(255,255,255,0.9);
        }

        .comparison-table td {
            color: rgba(255,255,255,0.7);
        }

        .comparison-table td.highlight {
            background: rgba(255,200,0,0.1);
            color: #ffc107;
        }

        /* Collections Sidebar */
        .collections-toggle {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            background: rgba(102,126,234,0.9);
            color: white;
            padding: 1rem 0.5rem;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            z-index: 600;
            transition: all 0.3s;
            writing-mode: vertical-rl;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .collections-toggle:hover {
            background: rgba(102,126,234,1);
            padding-right: 0.75rem;
        }

        .collections-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(102,126,234,0.3);
            z-index: 700;
            transition: right 0.3s ease;
            overflow-y: auto;
            padding: 2rem;
        }

        .collections-sidebar.open {
            right: 0;
        }

        .collections-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .collections-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .collections-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .collections-close:hover {
            background: rgba(255,255,255,0.1);
        }

        .collections-actions {
            margin-bottom: 2rem;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            width: 100%;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background: #7c8ef0;
            transform: translateY(-2px);
        }

        .collections-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .collection-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .collection-item:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(102,126,234,0.5);
        }

        .collection-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }

        .collection-item-name {
            font-weight: 600;
            font-size: 1rem;
            color: rgba(255,255,255,0.95);
        }

        .collection-item-badge {
            background: rgba(102,126,234,0.2);
            color: #a5b4fc;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .collection-item-description {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.6);
            margin-bottom: 0.5rem;
        }

        .collection-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.5);
        }

        .collection-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .icon-btn {
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            padding: 0.25rem;
            transition: color 0.3s;
        }

        .icon-btn:hover {
            color: rgba(255,255,255,1);
        }

        .icon-btn.delete:hover {
            color: #f87171;
        }

        /* Collection Modal */
        .collection-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 800;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .collection-modal.active {
            display: flex;
        }

        .collection-modal-content {
            background: rgba(20,20,20,0.98);
            border: 1px solid rgba(102,126,234,0.3);
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            padding: 2rem;
        }

        .collection-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .collection-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.8);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            border-color: #667eea;
            background: rgba(102,126,234,0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            accent-color: #667eea;
        }

        .smart-collection-filters {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(102,126,234,0.05);
            border-radius: 8px;
            border: 1px solid rgba(102,126,234,0.2);
        }

        .smart-collection-filters.visible {
            display: block;
        }

        .filter-row {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .filter-row > * {
            flex: 1;
        }

        .form-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        .smart-preview {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .smart-preview-title {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 0.5rem;
        }

        .smart-preview-items {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .smart-preview-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }

        /* Add to Collection Dropdown */
        .add-to-collection-btn {
            position: absolute;
            top: 0.75rem;
            right: 3rem;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            z-index: 6;
            transition: all 0.3s;
            opacity: 1;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .add-to-collection-btn:hover {
            background: rgba(102,126,234,0.8);
            border-color: rgba(102,126,234,1);
            transform: translateY(-1px);
        }

        .collection-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            background: rgba(20,20,20,0.98);
            border: 1px solid rgba(102,126,234,0.3);
            border-radius: 8px;
            padding: 0.5rem;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .collection-dropdown.active {
            display: block;
        }

        .collection-dropdown-item {
            padding: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255,255,255,0.8);
        }

        .collection-dropdown-item:hover {
            background: rgba(102,126,234,0.2);
            color: white;
        }

        .collection-dropdown-item.in-collection {
            background: rgba(102,126,234,0.1);
            border-left: 3px solid #667eea;
        }

        .collection-dropdown-item.new-collection {
            border-top: 1px solid rgba(255,255,255,0.1);
            margin-top: 0.5rem;
            color: #667eea;
            font-weight: 500;
        }

        .collection-dropdown-empty {
            padding: 1rem;
            text-align: center;
            color: rgba(255,255,255,0.5);
            font-size: 0.875rem;
        }

        .collection-badge {
            position: absolute;
            bottom: 0.75rem;
            left: 0.75rem;
            background: rgba(102,126,234,0.9);
            backdrop-filter: blur(10px);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            z-index: 5;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Modal Collection Button */
        .modal-collection-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
        }

        .modal-collection-btn:hover {
            background: rgba(102,126,234,0.2);
            border-color: rgba(102,126,234,0.5);
        }

        /* Generate Video Button */
        .generate-video-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .generate-video-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }

        .generate-video-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .generate-video-btn.generating {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Merge Videos Button */
        .merge-videos-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .merge-videos-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245,87,108,0.4);
        }

        .merge-videos-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Preset Modal */
        .preset-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 800;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .preset-modal.active {
            display: flex;
        }

        .preset-modal-content {
            background: rgba(20,20,20,0.98);
            border: 1px solid rgba(102,126,234,0.3);
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 2rem;
        }

        .preset-modal-content.preset-modal-small {
            max-width: 450px;
        }

        .preset-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .preset-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
        }

        .preset-modal-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color 0.2s ease;
        }

        .preset-modal-close:hover {
            color: white;
        }

        .preset-modal-body {
            color: white;
        }

        .preset-manager-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .preset-manager-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.2s ease;
        }

        .preset-manager-item.is-default {
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .preset-manager-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .preset-manager-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .preset-manager-name {
            font-weight: 600;
            font-size: 1rem;
            color: white;
        }

        .preset-manager-item.is-default .preset-manager-name::after {
            content: " (Default)";
            color: rgba(102, 126, 234, 1);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .preset-manager-actions {
            display: flex;
            gap: 0.5rem;
        }

        .preset-manager-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .preset-manager-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .preset-manager-btn.danger {
            color: #ef4444;
        }

        .preset-manager-btn.danger:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .preset-manager-filters {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.5);
            line-height: 1.5;
        }

        .preset-manager-empty {
            text-align: center;
            padding: 3rem 1rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .preset-manager-empty p {
            margin-bottom: 0.5rem;
        }

        .preset-current-filters {
            background: rgba(102, 126, 234, 0.05);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .preset-current-filters-title {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .preset-current-filters-list {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
        }

        .preset-current-filters-empty {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
        }

        /* Import Modal Styles */
        .import-btn {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .import-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .import-upload-zone {
            border: 2px dashed rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            background: rgba(102, 126, 234, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .import-upload-zone:hover {
            border-color: rgba(102, 126, 234, 0.6);
            background: rgba(102, 126, 234, 0.1);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .import-upload-zone h3 {
            color: white;
            margin: 1rem 0 0.5rem;
        }

        .import-upload-zone p {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 1.5rem;
        }

        .import-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .import-stat {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-label {
            display: block;
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 600;
            color: #667eea;
        }

        .import-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 1.5rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .download-list-container textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.875rem;
            resize: vertical;
            margin: 1rem 0;
        }

        .download-list-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1rem 0;
        }

        .download-note {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.875rem;
            font-style: italic;
            margin-top: 1rem;
        }

        .import-complete {
            text-align: center;
            padding: 2rem;
        }

        .success-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .import-complete h3 {
            color: white;
            margin: 1rem 0;
        }

        .import-results {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: left;
        }

        .import-results p {
            color: rgba(255, 255, 255, 0.9);
            margin: 0.5rem 0;
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 4rem;
            color: rgba(255,255,255,0.6);
        }

        /* Empty state */
        .empty {
            text-align: center;
            padding: 4rem;
            color: rgba(255,255,255,0.6);
        }

        /* Infinite Scroll Sentinel & Loading */
        .scroll-sentinel {
            height: 1px;
            visibility: hidden;
        }

        .infinite-scroll-loading {
            text-align: center;
            padding: 2rem;
            color: rgba(255,255,255,0.6);
            display: none;
        }

        .infinite-scroll-loading.visible {
            display: block;
        }

        .infinite-scroll-loading .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(102,126,234,0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .no-more-posts {
            text-align: center;
            padding: 2rem;
            color: rgba(255,255,255,0.4);
            font-size: 0.9rem;
            display: none;
        }

        .no-more-posts.visible {
            display: block;
        }

        /* Focus Indicators - Accessibility */
        *:focus-visible {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        /* Skip to main content link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #667eea;
            color: white;
            padding: 8px;
            text-decoration: none;
            z-index: 1000;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        .toast.toast-error {
            border-left: 4px solid #ea6666;
        }

        .toast.toast-success {
            border-left: 4px solid #66ea66;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Keyboard Shortcuts Helper */
        .shortcuts-hint {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(102,126,234,0.3);
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-size: 0.85rem;
            color: rgba(255,255,255,0.7);
            z-index: 100;
            opacity: 0.6;
            transition: opacity 0.3s;
        }

        .shortcuts-hint:hover {
            opacity: 1;
        }

        .shortcuts-hint kbd {
            background: rgba(102,126,234,0.2);
            border: 1px solid rgba(102,126,234,0.3);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8rem;
            color: #667eea;
            margin: 0 0.2rem;
        }

        /* Loading Skeleton */
        .skeleton-card {
            aspect-ratio: 1;
            background: linear-gradient(90deg, rgba(255,255,255,0.02) 25%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.02) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 12px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Reduced Motion Support - Accessibility */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Responsive Design - Mobile First */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .title {
                font-size: 1.25rem;
            }

            .stats {
                flex-direction: column;
                gap: 0.5rem;
                font-size: 0.85rem;
                width: 100%;
            }

            .filters {
                padding: 1rem;
            }

            .filters-content {
                flex-direction: column;
                gap: 0.75rem;
            }

            .filter-group {
                width: 100%;
                flex-direction: column;
                align-items: flex-start;
            }

            .filter-group select,
            .filter-group input {
                width: 100%;
            }

            input[type="text"] {
                min-width: 100%;
            }

            .gallery {
                padding: 1rem;
            }

            .gallery-grid {
                column-count: 1;
                column-gap: 1rem;
            }

            /* Mobile Modal */
            .modal-viewer {
                padding: 2rem 1rem 10rem;
            }

            .nav-arrow {
                width: 60px;
                height: 60px;
                font-size: 2rem;
            }

            .nav-arrow.prev { left: 0.5rem; }
            .nav-arrow.next { right: 0.5rem; }

            .modal-close {
                top: 1rem;
                right: 1rem;
                width: 50px;
                height: 50px;
            }

            .modal-controls {
                flex-direction: column;
                gap: 1rem;
                padding: 2rem 1rem 1rem;
            }

            .mode-buttons {
                width: 100%;
                justify-content: center;
            }

            .iteration-dots {
                order: -1;
            }

            .post-counter {
                text-align: center;
            }
        }

        /* Tablet */
        @media (min-width: 769px) and (max-width: 1024px) {
            .gallery-grid {
                column-count: 2;
            }

            .filters-content {
                gap: 0.75rem;
            }
        }

        /* Medium Desktop */
        @media (min-width: 1025px) and (max-width: 1399px) {
            .gallery-grid {
                column-count: 3;
            }
        }

        /* Large Desktop */
        @media (min-width: 1400px) and (max-width: 1799px) {
            .gallery-grid {
                column-count: 4;
            }
        }

        /* Extra Large Desktop */
        @media (min-width: 1800px) {
            .gallery-grid {
                column-count: 6;
            }
        }

        /* Touch Device Optimizations */
        @media (hover: none) and (pointer: coarse) {
            .nav-arrow {
                width: 60px;
                height: 60px;
            }

            .modal-close {
                width: 50px;
                height: 50px;
            }

            .mode-btn {
                padding: 1rem 1.5rem;
                font-size: 1rem;
            }

            /* Remove hover effects on touch */
            .gallery-item:hover {
                transform: none;
            }

            /* Always show overlay on touch devices */
            .gallery-item-overlay {
                opacity: 0.9;
            }
        }

        /* High contrast mode for better visibility */
        @media (hover: hover) {
            .gallery-item:hover {
                transform: translateY(-4px);
                box-shadow: 0 12px 40px rgba(0,0,0,0.6);
            }

            .gallery-item:hover .gallery-item-overlay {
                opacity: 1;
            }
        }

        /* View Controls */
        .view-controls {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 2rem;
            position: sticky;
            top: var(--header-height, 80px);
            z-index: 90;
        }

        .view-controls-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 2rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-group label {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .view-mode-buttons, .density-buttons {
            display: flex;
            gap: 0.25rem;
            background: rgba(255, 255, 255, 0.05);
            padding: 0.25rem;
            border-radius: 8px;
        }

        .view-mode-btn, .density-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .view-mode-btn:hover, .density-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }

        .view-mode-btn.active, .density-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .density-btn span {
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0 0.5rem;
        }

        #sortSelect, #columnCount {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #sortSelect:hover, #columnCount:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        #sortSelect:focus, #columnCount:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        /* Density CSS Variables */
        :root {
            --density-spacing: 1rem;
            --density-card-padding: 1rem;
            --density-gap: 1.5rem;
        }

        body[data-density="compact"] {
            --density-spacing: 0.5rem;
            --density-card-padding: 0.5rem;
            --density-gap: 0.75rem;
        }

        body[data-density="spacious"] {
            --density-spacing: 1.5rem;
            --density-card-padding: 1.5rem;
            --density-gap: 2rem;
        }

        /* Apply density to gallery */
        body[data-density="compact"] .gallery-grid {
            column-gap: var(--density-gap);
        }

        body[data-density="spacious"] .gallery-grid {
            column-gap: var(--density-gap);
        }

        body[data-density="compact"] .gallery-item {
            margin-bottom: var(--density-gap);
        }

        body[data-density="spacious"] .gallery-item {
            margin-bottom: var(--density-gap);
        }

        /* Grid View Mode */
        body[data-view-mode="grid"] .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            column-count: unset;
            gap: var(--density-gap, 1.5rem);
        }

        body[data-view-mode="grid"] .gallery-item {
            break-inside: unset;
            margin-bottom: 0;
            display: flex;
            flex-direction: column;
        }

        body[data-view-mode="grid"] .gallery-item img {
            width: 100%;
            height: 280px;
            object-fit: cover;
        }

        /* List View Mode */
        body[data-view-mode="list"] .gallery-grid {
            display: flex;
            flex-direction: column;
            column-count: unset;
            gap: var(--density-spacing, 1rem);
        }

        body[data-view-mode="list"] .gallery-item {
            break-inside: unset;
            margin-bottom: 0;
            display: flex;
            flex-direction: row;
            align-items: center;
            height: 120px;
        }

        body[data-view-mode="list"] .gallery-item img {
            width: 200px;
            height: 120px;
            object-fit: cover;
            flex-shrink: 0;
        }

        body[data-view-mode="list"] .gallery-item-overlay {
            position: relative;
            opacity: 1;
            background: transparent;
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: var(--density-card-padding, 1rem);
        }

        body[data-view-mode="list"] .overlay-top {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
        }

        body[data-view-mode="list"] .overlay-bottom {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        body[data-view-mode="list"] .video-badge {
            position: absolute;
            top: 0.5rem;
            left: 210px;
        }

        /* Preset Controls */
        .preset-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .preset-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .preset-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .preset-btn.save-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
        }

        .preset-btn.manage-btn {
            padding: 0.5rem 0.75rem;
            font-size: 1.1rem;
        }

        .preset-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Preset Dropdown */
        .preset-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            background: rgba(30, 30, 40, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            min-width: 280px;
            max-width: 400px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .preset-dropdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 600;
            color: white;
        }

        .preset-dropdown-header button {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color 0.2s ease;
        }

        .preset-dropdown-header button:hover {
            color: white;
        }

        .preset-list {
            padding: 0.5rem;
        }

        .preset-empty {
            padding: 2rem;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.875rem;
        }

        .preset-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.25rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .preset-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .preset-item.is-default {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .preset-item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .preset-item-name {
            color: white;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .preset-item.is-default .preset-item-name::after {
            content: " (Default)";
            color: rgba(102, 126, 234, 1);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .preset-item-filters {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.75rem;
        }

        .preset-item-actions {
            display: flex;
            gap: 0.25rem;
        }

        .preset-action-btn {
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: rgba(255, 255, 255, 0.6);
            padding: 0.375rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .preset-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .preset-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Column count override */
        body[data-manual-columns="2"] .gallery-grid {
            column-count: 2 !important;
        }

        body[data-manual-columns="3"] .gallery-grid {
            column-count: 3 !important;
        }

        body[data-manual-columns="4"] .gallery-grid {
            column-count: 4 !important;
        }

        body[data-manual-columns="5"] .gallery-grid {
            column-count: 5 !important;
        }

        body[data-manual-columns="6"] .gallery-grid {
            column-count: 6 !important;
        }

        body[data-manual-columns="7"] .gallery-grid {
            column-count: 7 !important;
        }

        body[data-manual-columns="8"] .gallery-grid {
            column-count: 8 !important;
        }

        /* Grid mode column override */
        body[data-view-mode="grid"][data-manual-columns="2"] .gallery-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        body[data-view-mode="grid"][data-manual-columns="3"] .gallery-grid {
            grid-template-columns: repeat(3, 1fr);
        }

        body[data-view-mode="grid"][data-manual-columns="4"] .gallery-grid {
            grid-template-columns: repeat(4, 1fr);
        }

        body[data-view-mode="grid"][data-manual-columns="5"] .gallery-grid {
            grid-template-columns: repeat(5, 1fr);
        }

        body[data-view-mode="grid"][data-manual-columns="6"] .gallery-grid {
            grid-template-columns: repeat(6, 1fr);
        }

        body[data-view-mode="grid"][data-manual-columns="7"] .gallery-grid {
            grid-template-columns: repeat(7, 1fr);
        }

        body[data-view-mode="grid"][data-manual-columns="8"] .gallery-grid {
            grid-template-columns: repeat(8, 1fr);
        }

        /* Mobile responsiveness for view controls */
        @media (max-width: 768px) {
            .view-controls {
                padding: 0.75rem 1rem;
            }

            .view-controls-content {
                gap: 1rem;
            }

            .control-group {
                font-size: 0.8rem;
            }

            .density-btn span {
                font-size: 0.7rem;
                padding: 0 0.3rem;
            }

            body[data-view-mode="list"] .gallery-item {
                height: 80px;
            }

            body[data-view-mode="list"] .gallery-item img {
                width: 120px;
                height: 80px;
            }

            body[data-view-mode="list"] .video-badge {
                left: 130px;
            }

            /* Comparison modal responsive */
            .comparison-modal-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .comparison-controls {
                width: 100%;
                justify-content: flex-start;
            }

            .comparison-grid[data-columns="2"],
            .comparison-grid[data-columns="3"],
            .comparison-grid[data-columns="4"],
            .comparison-grid[data-columns="5"],
            .comparison-grid[data-columns="6"] {
                grid-template-columns: 1fr !important;
            }

            /* Masonry mode on mobile */
            .comparison-grid[data-view-mode="masonry"][data-columns="2"],
            .comparison-grid[data-view-mode="masonry"][data-columns="3"],
            .comparison-grid[data-view-mode="masonry"][data-columns="4"],
            .comparison-grid[data-view-mode="masonry"][data-columns="5"],
            .comparison-grid[data-view-mode="masonry"][data-columns="6"] {
                column-count: 1 !important;
            }
        }

        /* ============================================
           PROMPT LIBRARY SIDEBAR STYLES
           ============================================ */
        .prompt-library-sidebar {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: rgba(10, 10, 10, 0.98);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255,255,255,0.1);
            z-index: 1000;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .prompt-library-sidebar.open {
            right: 0;
        }

        .prompt-library-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .prompt-library-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .prompt-library-close {
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            transition: color 0.2s;
        }

        .prompt-library-close:hover {
            color: white;
        }

        .prompt-library-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .prompt-search-box {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .prompt-search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: white;
            font-size: 0.9rem;
        }

        .prompt-search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
        }

        .prompt-section {
            margin-bottom: 2rem;
        }

        .prompt-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .prompt-section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: rgba(255,255,255,0.8);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .prompt-item {
            padding: 0.75rem;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .prompt-item:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(102,126,234,0.3);
            transform: translateX(-4px);
        }

        .prompt-item-text {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.9);
            margin-bottom: 0.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .prompt-item-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.5);
        }

        .prompt-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .prompt-stat-card {
            background: rgba(102,126,234,0.1);
            border: 1px solid rgba(102,126,234,0.2);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
        }

        .prompt-stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #a5b4fc;
        }

        .prompt-stat-label {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.6);
            margin-top: 0.25rem;
        }

        .prompt-generate-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .prompt-generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102,126,234,0.3);
        }

        /* ============================================
           PROMPT STUDIO MODAL STYLES
           ============================================ */
        .prompt-studio-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .prompt-studio-modal.active {
            display: flex;
        }

        .prompt-studio-content {
            background: #1a1a1a;
            border-radius: 16px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .prompt-studio-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .prompt-studio-title {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .prompt-studio-body {
            padding: 2rem;
        }

        .prompt-input-section {
            margin-bottom: 2rem;
        }

        .prompt-input-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: rgba(255,255,255,0.8);
            margin-bottom: 0.5rem;
        }

        .prompt-input-textarea {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
        }

        .prompt-input-textarea:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(102,126,234,0.08);
        }

        .prompt-options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .prompt-option-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .prompt-variations-container {
            margin-top: 2rem;
        }

        .prompt-variations-header {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .prompt-variation-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .prompt-variation-card:hover {
            background: rgba(255,255,255,0.05);
            border-color: rgba(102,126,234,0.3);
        }

        .prompt-variation-text {
            font-size: 0.95rem;
            line-height: 1.6;
            color: rgba(255,255,255,0.9);
            margin-bottom: 1rem;
        }

        .prompt-variation-actions {
            display: flex;
            gap: 0.5rem;
        }

        .prompt-variation-btn {
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: rgba(255,255,255,0.8);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .prompt-variation-btn:hover {
            background: rgba(102,126,234,0.2);
            border-color: rgba(102,126,234,0.4);
            color: white;
        }

        /* ============================================
           ENHANCED GALLERY CARD STYLES
           ============================================ */
        .gallery-item-prompt-preview {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.7) 70%, transparent 100%);
            padding: 2rem 1rem 1rem 1rem;
            font-size: 0.85rem;
            line-height: 1.4;
            color: rgba(255,255,255,0.9);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .gallery-item-prompt-expand {
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
            background: rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            transition: all 0.2s;
        }

        .gallery-item-prompt-expand:hover {
            background: rgba(102,126,234,0.3);
            border-color: rgba(102,126,234,0.5);
            color: white;
        }

        /* ============================================
           QUICK ACTION BUTTONS - ALWAYS VISIBLE
           ============================================ */
        .quick-actions-bar {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            z-index: 10;
        }

        .quick-action-new {
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 0.5rem;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.1rem;
            line-height: 1;
        }

        .quick-action-new:hover {
            background: rgba(102,126,234,0.3);
            border-color: rgba(102,126,234,0.5);
            transform: scale(1.1);
        }

        .quick-action-new.primary {
            background: rgba(102,126,234,0.3);
            border-color: rgba(102,126,234,0.5);
        }

        /* ============================================
           PROMPT LIBRARY TOGGLE BUTTON
           ============================================ */
        .prompt-library-toggle {
            position: fixed;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px 0 0 12px;
            padding: 1rem 0.75rem;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            z-index: 999;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            box-shadow: -4px 0 20px rgba(102,126,234,0.3);
            transition: all 0.3s;
        }

        .prompt-library-toggle:hover {
            transform: translateY(-50%) translateX(-4px);
            box-shadow: -8px 0 30px rgba(102,126,234,0.5);
        }

        .prompt-library-toggle.active {
            right: 400px;
        }

        /* ============================================
           KEYBOARD SHORTCUTS INDICATOR
           ============================================ */
        .keyboard-shortcut-hint {
            display: inline-block;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            padding: 0.125rem 0.375rem;
            font-size: 0.7rem;
            font-family: monospace;
            margin-left: 0.5rem;
            opacity: 0.6;
        }

        /* ============================================
           RESPONSIVE ADJUSTMENTS
           ============================================ */
        @media (max-width: 768px) {
            .prompt-library-sidebar {
                width: 100%;
                right: -100%;
            }

            .prompt-library-sidebar.open {
                right: 0;
            }

            .prompt-library-toggle.active {
                right: 0;
                opacity: 0.3;
            }

            .prompt-studio-content {
                width: 95%;
                max-height: 95vh;
            }

            .prompt-options-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <!-- Shared JavaScript Modules -->
    <script src="js/config.js"></script>
    <script src="js/shared-utils.js"></script>
    <script src="js/api-client.js"></script>
</head>
<body>
    <!-- Filters -->
    <div class="filters" role="search" aria-label="Filter gallery">
        <div class="filters-content">
            <div class="filter-group">
                <label for="typeFilter">Type:</label>
                <select id="typeFilter" aria-label="Filter by media type">
                    <option value="all">All</option>
                    <option value="image">Images</option>
                    <option value="video">Videos</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="likedFilter">Liked:</label>
                <select id="likedFilter" aria-label="Filter by liked status">
                    <option value="all">All</option>
                    <option value="liked">Liked Only</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="modelFilter">Model:</label>
                <select id="modelFilter" aria-label="Filter by AI model">
                    <option value="all">All Models</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="modeFilter">Mode:</label>
                <select id="modeFilter" aria-label="Filter by generation mode">
                    <option value="all">All</option>
                    <option value="custom">Custom</option>
                    <option value="normal">Normal</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="hasCustomVideosFilter">
                    <input type="checkbox" id="hasCustomVideosFilter" style="margin-right: 0.3rem;" aria-label="Show only posts with custom videos">
                    Has Custom Videos
                </label>
            </div>
            <div class="filter-group">
                <label for="searchInput">Search:</label>
                <input type="text" id="searchInput" placeholder="Search prompts..." aria-label="Search gallery by prompt">
            </div>
            <div class="filter-group">
                <div class="preset-controls">
                    <button class="preset-btn" id="presetDropdownBtn" onclick="togglePresetDropdown()" aria-label="Filter presets">
                        📌 Presets <span class="preset-count" id="presetCount">0</span>
                    </button>
                    <button class="preset-btn save-btn" onclick="saveCurrentPreset()" aria-label="Save current filters" title="Save current filters">
                        💾 Save
                    </button>
                    <button class="preset-btn manage-btn" onclick="openPresetManager()" aria-label="Manage presets" title="Manage presets">
                        ⚙️
                    </button>
                </div>
                <div class="preset-dropdown" id="presetDropdown" style="display: none;">
                    <div class="preset-dropdown-header">
                        <span>Saved Filter Presets</span>
                        <button onclick="togglePresetDropdown()" aria-label="Close">×</button>
                    </div>
                    <div class="preset-list" id="presetList">
                        <div class="preset-empty">No saved presets yet</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- View Controls -->
    <div class="view-controls" role="toolbar" aria-label="View and layout controls">
        <div class="view-controls-content">
            <div class="control-group">
                <label>View Mode:</label>
                <div class="view-mode-buttons" role="group" aria-label="View mode selection">
                    <button class="view-mode-btn active" data-mode="masonry" onclick="setViewMode('masonry')" aria-pressed="true" title="Masonry layout">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <rect x="1" y="1" width="7" height="5"></rect>
                            <rect x="10" y="1" width="9" height="7"></rect>
                            <rect x="1" y="8" width="7" height="11"></rect>
                            <rect x="10" y="10" width="9" height="9"></rect>
                        </svg>
                    </button>
                    <button class="view-mode-btn" data-mode="grid" onclick="setViewMode('grid')" aria-pressed="false" title="Grid layout">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <rect x="1" y="1" width="8" height="8"></rect>
                            <rect x="11" y="1" width="8" height="8"></rect>
                            <rect x="1" y="11" width="8" height="8"></rect>
                            <rect x="11" y="11" width="8" height="8"></rect>
                        </svg>
                    </button>
                    <button class="view-mode-btn" data-mode="list" onclick="setViewMode('list')" aria-pressed="false" title="List layout">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <rect x="1" y="2" width="18" height="4"></rect>
                            <rect x="1" y="8" width="18" height="4"></rect>
                            <rect x="1" y="14" width="18" height="4"></rect>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="control-group">
                <label>Density:</label>
                <div class="density-buttons" role="group" aria-label="Card density selection">
                    <button class="density-btn" data-density="compact" onclick="setDensity('compact')" title="Compact">
                        <span>Compact</span>
                    </button>
                    <button class="density-btn active" data-density="comfortable" onclick="setDensity('comfortable')" title="Comfortable">
                        <span>Comfortable</span>
                    </button>
                    <button class="density-btn" data-density="spacious" onclick="setDensity('spacious')" title="Spacious">
                        <span>Spacious</span>
                    </button>
                </div>
            </div>
            <div class="control-group">
                <label for="sortSelect">Sort:</label>
                <select id="sortSelect" aria-label="Sort gallery">
                    <option value="date_desc">Newest First</option>
                    <option value="date_asc">Oldest First</option>
                    <option value="likes">Most Liked</option>
                    <option value="model">By Model</option>
                    <option value="random">Random</option>
                </select>
            </div>
            <div class="control-group">
                <label for="columnCount">Columns:</label>
                <select id="columnCount" aria-label="Column count">
                    <option value="auto">Auto</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                </select>
            </div>
            <div class="control-group" style="margin-left: auto;">
                <button class="btn btn-primary btn-sm" onclick="openVideoChainsModal()" aria-label="View video chains">
                    🔗 Video Chains
                </button>
                <button class="btn btn-primary btn-sm" onclick="openImportModal()" aria-label="Import JSON data">
                    📥 Import JSON
                </button>
            </div>
        </div>
    </div>

    <!-- Active Filters -->
    <div class="active-filters" id="activeFilters" role="status" aria-live="polite">
        <div class="active-filters-content">
            <span class="active-filters-label">Active filters:</span>
            <div id="filterChips" role="list" aria-label="Active filters"></div>
            <span id="loadedCount" style="margin-left: auto; color: rgba(255,255,255,0.6); font-size: 0.9rem;"></span>
            <button class="clear-all-filters" id="clearAllFilters" onclick="clearAllFilters()" aria-label="Clear all filters" style="display: none;">
                Clear All
            </button>
        </div>
    </div>

    <!-- Gallery Grid -->
    <main id="main-content" class="gallery" role="main" aria-label="Media gallery">
        <div class="gallery-grid" id="galleryGrid" role="list" aria-label="Gallery items">
            <div class="loading" role="status" aria-live="polite">Loading gallery...</div>
        </div>
        <div class="scroll-sentinel" id="scrollSentinel"></div>
        <div class="infinite-scroll-loading" id="infiniteScrollLoading">
            <div class="spinner" role="status" aria-label="Loading more posts"></div>
            <div>Loading more posts...</div>
        </div>
        <div class="no-more-posts" id="noMorePosts">
            You've reached the end
        </div>
    </main>

    <!-- Keyboard Shortcuts Hint -->
    <div class="shortcuts-hint" role="complementary" aria-label="Keyboard shortcuts">
        <kbd>←</kbd> <kbd>→</kbd> Navigate • <kbd>Esc</kbd> Close • <kbd>I</kbd> Image • <kbd>V</kbd> Video
    </div>

    <!-- Modal Viewer -->
    <div class="modal" id="modal" role="dialog" aria-modal="true" aria-label="Media viewer">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()" aria-label="Close modal (press Escape)">×</button>

            <div class="modal-viewer">
                <button class="nav-arrow prev" onclick="navigateInModal(-1)" aria-label="Previous image or video (Left arrow key)">‹</button>
                <div class="modal-media" id="modalMedia" role="img" aria-live="polite"></div>
                <button class="nav-arrow next" onclick="navigateInModal(1)" aria-label="Next image or video (Right arrow key)">›</button>
            </div>

            <div class="modal-controls">
                <div class="modal-prompt" id="modalPrompt" aria-live="polite"></div>

                <div class="mode-controls">
                    <div class="mode-buttons" role="group" aria-label="View mode selection">
                        <button class="mode-btn active" data-mode="image" onclick="setMode('image')" aria-pressed="true">
                            🖼️ Image
                        </button>
                        <button class="mode-btn" data-mode="video" onclick="setMode('video')" aria-pressed="false">
                            🎬 Video
                        </button>
                    </div>

                    <div class="iteration-dots" id="iterationDots" role="group" aria-label="Video iteration navigation"></div>

                    <!-- Collection button in modal -->
                    <div class="modal-collection-btn" id="modalCollectionBtn" onclick="toggleModalCollectionDropdown(event)" title="Add to collection">
                        📁 Collections
                        <div class="collection-dropdown" id="modal-collection-dropdown"></div>
                    </div>

                    <!-- Generate Video section with model selector -->
                    <div style="display: none; gap: 0.5rem; align-items: center;" id="generateVideoSection">
                        <select id="modelSelector" onchange="saveModelPreference()" style="padding: 0.5rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.3); color: white; cursor: pointer;" title="Choose AI model">
                            <option value="svd" selected>SVD (2s, faster, recommended)</option>
                            <option value="wan">Wan 2.1 (3-7s, better quality, slow)</option>
                        </select>
                        <button class="generate-video-btn" id="generateVideoBtn" onclick="generateVideoFromImage()" title="Generate video from this image">
                            🎬 Generate Video
                        </button>
                    </div>

                    <!-- Merge Videos button (only in video mode with multiple videos) -->
                    <button class="merge-videos-btn" id="mergeVideosBtn" onclick="openMergeModal()" title="Merge multiple videos with AI transitions" style="display: none;">
                        🎞️ Merge Videos
                    </button>

                    <div class="post-counter" id="postCounter" aria-live="polite"></div>
                </div>
            </div>

            <!-- Similar Items Section -->
            <div class="similar-items" id="similarItems" style="display: none;">
                <div class="similar-items-header">
                    <div class="similar-items-title">Similar Items</div>
                </div>
                <div id="similarItemsContent">
                    <div class="similar-items-loading">Finding similar items...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparison Bar -->
    <div class="comparison-bar" id="comparisonBar">
        <div class="comparison-bar-content">
            <div class="comparison-count" id="comparisonCount">0 items selected</div>
            <div class="comparison-items" id="comparisonItems"></div>
            <div class="comparison-actions">
                <button class="compare-btn secondary" onclick="clearComparison()">Clear All</button>
                <button class="compare-btn secondary" onclick="bulkAddToCollection()" id="bulkCollectionBtn" disabled>📁 Add to Collection</button>
                <button class="compare-btn" onclick="openComparisonModal()" id="compareNowBtn" disabled>Compare Now</button>
            </div>
        </div>
    </div>

    <!-- Comparison Modal -->
    <div class="comparison-modal" id="comparisonModal">
        <div class="comparison-modal-header">
            <div class="comparison-modal-title">Comparison View</div>
            <div class="comparison-controls">
                <!-- View Mode Toggle -->
                <div style="display: flex; gap: 0.25rem; margin-right: 1rem;">
                    <button class="view-mode-btn active" data-mode="grid" onclick="setComparisonViewMode('grid')" title="Grid view">
                        ⊞
                    </button>
                    <button class="view-mode-btn" data-mode="masonry" onclick="setComparisonViewMode('masonry')" title="Masonry view">
                        ▦
                    </button>
                </div>

                <!-- Sort Options -->
                <label for="comparisonSort" style="margin-right: 0.5rem; color: rgba(255,255,255,0.8); font-size: 0.9rem;">
                    Sort:
                </label>
                <select id="comparisonSort" onchange="sortComparisonItems()" style="padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; margin-right: 1rem;">
                    <option value="default">Selection Order</option>
                    <option value="date_desc">Newest First</option>
                    <option value="date_asc">Oldest First</option>
                    <option value="model">Model Name</option>
                    <option value="prompt">Prompt A-Z</option>
                </select>

                <!-- Column Count -->
                <label for="comparisonColumns" style="margin-right: 0.5rem; color: rgba(255,255,255,0.8); font-size: 0.9rem;">
                    Columns:
                </label>
                <select id="comparisonColumns" onchange="updateComparisonColumns()" style="padding: 0.5rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white; margin-right: 1rem;">
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4" selected>4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                </select>

                <!-- Video Controls -->
                <button class="btn btn-sm btn-secondary" onclick="playAllComparisonVideos()" style="margin-right: 0.5rem;">
                    ▶️ Play All
                </button>
                <button class="btn btn-sm btn-ghost" onclick="pauseAllComparisonVideos()">
                    ⏸️ Pause
                </button>
            </div>
            <button class="modal-close" onclick="closeComparisonModal()">×</button>
        </div>
        <div class="comparison-grid" id="comparisonGrid" data-view-mode="grid"></div>
        <div class="comparison-table" id="comparisonTable"></div>
    </div>

    <!-- Collections Toggle Button -->
    <div class="collections-toggle" onclick="toggleCollectionsSidebar()">
        Collections
    </div>

    <!-- Import JSON Modal -->
    <!-- Video Chains Modal -->
    <div class="preset-modal" id="videoChainsModal">
        <div class="preset-modal-content" style="max-width: 1200px;">
            <div class="preset-modal-header">
                <div class="preset-modal-title">🔗 Video Chains</div>
                <button class="preset-modal-close" onclick="closeVideoChainsModal()">×</button>
            </div>

            <div class="preset-modal-body">
                <!-- Analysis Status -->
                <div id="analysisStatus" style="display: none; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div class="spinner" style="width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <span id="analysisStatusText">Analyzing videos...</span>
                    </div>
                </div>

                <!-- Controls -->
                <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                    <button class="btn-primary" onclick="analyzeAllVideos()" id="analyzeBtn">
                        🔍 Analyze All Videos
                    </button>
                    <button class="btn-primary" onclick="loadVideoChains()" id="loadChainsBtn">
                        📊 Find Video Chains
                    </button>
                    <div style="display: flex; gap: 0.5rem; align-items: center; margin-left: auto;">
                        <label for="thresholdInput" style="font-size: 0.9rem;">Match Threshold:</label>
                        <input type="number" id="thresholdInput" value="10" min="0" max="50" style="width: 80px; padding: 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white;">
                        <label for="minChainLength" style="font-size: 0.9rem; margin-left: 1rem;">Min Length:</label>
                        <input type="number" id="minChainLength" value="2" min="2" max="10" style="width: 80px; padding: 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: white;">
                    </div>
                </div>

                <!-- Stats -->
                <div id="chainStats" style="display: none; padding: 1rem; background: rgba(34, 197, 94, 0.1); border-radius: 8px; margin-bottom: 1.5rem;">
                    <div style="display: flex; gap: 2rem;">
                        <div>
                            <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">Total Videos</div>
                            <div style="font-size: 1.5rem; font-weight: bold;" id="totalVideos">0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">Chains Found</div>
                            <div style="font-size: 1.5rem; font-weight: bold;" id="totalChains">0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">Longest Chain</div>
                            <div style="font-size: 1.5rem; font-weight: bold;" id="longestChain">0 videos</div>
                        </div>
                    </div>
                </div>

                <!-- Chains List -->
                <div id="chainsList" style="max-height: 600px; overflow-y: auto;">
                    <div style="color: rgba(255,255,255,0.6); text-align: center; padding: 3rem;">
                        Click "Analyze All Videos" to start extracting frame data, then "Find Video Chains" to discover chains.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="preset-modal" id="importModal">
        <div class="preset-modal-content" style="max-width: 800px;">
            <div class="preset-modal-header">
                <div class="preset-modal-title">Import JSON Data</div>
                <button class="preset-modal-close" onclick="closeImportModal()">×</button>
            </div>

            <div class="preset-modal-body">
                <!-- Step 1: Upload JSON -->
                <div id="importStep1">
                    <div class="import-upload-zone" id="uploadZone">
                        <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="handleFileSelect(event)">
                        <div class="upload-icon">📁</div>
                        <h3>Upload JSON File</h3>
                        <p>Drag & drop or click to select a JSON file containing media posts</p>
                        <button class="btn-primary" onclick="document.getElementById('jsonFileInput').click()">Select File</button>
                    </div>
                </div>

                <!-- Step 2: Preview & Options -->
                <div id="importStep2" style="display: none;">
                    <div class="import-preview">
                        <h3>Import Summary</h3>
                        <div class="import-stats">
                            <div class="import-stat">
                                <span class="stat-label">Total Media Posts:</span>
                                <span class="stat-value" id="importTotalPosts">0</span>
                            </div>
                            <div class="import-stat">
                                <span class="stat-label">New Posts to Import:</span>
                                <span class="stat-value" id="importNewPosts">0</span>
                            </div>
                            <div class="import-stat">
                                <span class="stat-label">Existing Posts (Skip):</span>
                                <span class="stat-value" id="importExistingPosts">0</span>
                            </div>
                            <div class="import-stat">
                                <span class="stat-label">Total Child Posts:</span>
                                <span class="stat-value" id="importChildPosts">0</span>
                            </div>
                            <div class="import-stat">
                                <span class="stat-label">Media Files to Download:</span>
                                <span class="stat-value" id="importVideosToDownload">0</span>
                            </div>
                        </div>

                        <div class="import-actions">
                            <button class="btn-secondary" onclick="generateDownloadList()">
                                📋 Generate Download List
                            </button>
                            <button class="btn-primary" onclick="startImport()">
                                ✨ Import to Database
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Processing -->
                <div id="importStep3" style="display: none;">
                    <div class="import-progress">
                        <h3>Importing Data...</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" id="importProgressFill"></div>
                        </div>
                        <p id="importProgressText">Processing...</p>
                    </div>
                </div>

                <!-- Step 4: Download List -->
                <div id="importStep4" style="display: none;">
                    <div class="download-list-container">
                        <h3>Video Download URLs</h3>
                        <p>Copy these URLs to download the videos locally:</p>
                        <textarea id="downloadUrlsList" readonly rows="15"></textarea>
                        <div class="download-list-actions">
                            <button class="btn-secondary" onclick="copyDownloadList()">📋 Copy All URLs</button>
                            <button class="btn-primary" onclick="downloadUrlsAsFile()">💾 Download as TXT</button>
                        </div>
                        <p class="download-note">After downloading videos locally, click "Import to Database" to complete the import.</p>
                    </div>
                </div>

                <!-- Step 5: Complete -->
                <div id="importStep5" style="display: none;">
                    <div class="import-complete">
                        <div class="success-icon">✅</div>
                        <h3>Import Complete!</h3>
                        <div class="import-results" id="importResults"></div>
                        <button class="btn-primary" onclick="closeImportModal(); location.reload();">
                            Done
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Collections Sidebar -->
    <div class="collections-sidebar" id="collectionsSidebar">
        <div class="collections-header">
            <div class="collections-title">Collections</div>
            <button class="collections-close" onclick="toggleCollectionsSidebar()">×</button>
        </div>

        <div class="collections-actions">
            <button class="btn-primary" onclick="openCollectionModal()">
                + New Collection
            </button>
        </div>

        <div class="collections-list" id="collectionsList">
            <div class="loading">Loading collections...</div>
        </div>
    </div>

    <!-- Merge Videos Modal -->
    <div class="preset-modal" id="mergeVideosModal" style="display: none;">
        <div class="preset-modal-content">
            <div class="preset-modal-header">
                <h2>Merge Videos with AI Transitions</h2>
                <button class="preset-close" onclick="closeMergeModal()">×</button>
            </div>
            <div class="preset-modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 1rem;">
                        Select which videos to merge. They will be combined in the order shown with smooth AI transitions.
                    </p>

                    <div id="mergeVideosList" style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 400px; overflow-y: auto; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <!-- Video items will be inserted here -->
                    </div>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                        <input type="checkbox" id="useTransitionsCheck" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-size: 1rem;">Enable AI Smooth Transitions (RIFE)</span>
                    </label>
                    <p style="color: rgba(255,255,255,0.5); font-size: 0.85rem; margin-top: 0.5rem; margin-left: 2rem;">
                        When enabled, creates smooth morphing transitions between videos. Slower but higher quality.
                    </p>
                </div>

                <div id="transitionsOptions" style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: rgba(255,255,255,0.9);">
                        Transition Frames: <span id="transitionFramesValue">10</span>
                    </label>
                    <input type="range" id="transitionFramesSlider" min="5" max="30" value="10"
                           style="width: 100%;"
                           oninput="document.getElementById('transitionFramesValue').textContent = this.value">
                    <p style="color: rgba(255,255,255,0.5); font-size: 0.85rem; margin-top: 0.5rem;">
                        More frames = smoother transitions but slower processing
                    </p>
                </div>

                <div style="display: flex; gap: 1rem;">
                    <button onclick="closeMergeModal()" style="flex: 1; padding: 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 8px; cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="executeMergeVideos()" style="flex: 1; padding: 0.75rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none; color: white; border-radius: 8px; cursor: pointer; font-weight: 500;">
                        🎞️ Merge Videos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Collection Creation/Edit Modal -->
    <div class="collection-modal" id="collectionModal">
        <div class="collection-modal-content">
            <div class="collection-modal-header">
                <div class="collection-modal-title" id="collectionModalTitle">New Collection</div>
                <button class="collections-close" onclick="closeCollectionModal()">×</button>
            </div>

            <form id="collectionForm" onsubmit="saveCollection(event)">
                <div class="form-group">
                    <label for="collectionName">Name *</label>
                    <input type="text" id="collectionName" required maxlength="100" placeholder="My Collection">
                </div>

                <div class="form-group">
                    <label for="collectionDescription">Description</label>
                    <textarea id="collectionDescription" placeholder="Optional description"></textarea>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="isSmartCollection" onchange="toggleSmartFilters()">
                        <label for="isSmartCollection">Smart Collection (Auto-filter)</label>
                    </div>
                </div>

                <div class="smart-collection-filters" id="smartFilters">
                    <div class="filter-row">
                        <div class="form-group">
                            <label for="smartModel">Model</label>
                            <select id="smartModel" onchange="previewSmartCollection()">
                                <option value="all">All Models</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="smartMode">Mode</label>
                            <select id="smartMode" onchange="previewSmartCollection()">
                                <option value="all">All</option>
                                <option value="custom">Custom</option>
                                <option value="normal">Normal</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="smartSearch">Keywords</label>
                        <input type="text" id="smartSearch" placeholder="Search prompts..." oninput="previewSmartCollection()">
                    </div>

                    <div class="smart-preview" id="smartPreview"></div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeCollectionModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Collection</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Preset Management Modal -->
    <div class="preset-modal" id="presetModal">
        <div class="preset-modal-content">
            <div class="preset-modal-header">
                <div class="preset-modal-title">Manage Filter Presets</div>
                <button class="preset-modal-close" onclick="closePresetModal()">×</button>
            </div>

            <div class="preset-modal-body">
                <div class="preset-manager-list" id="presetManagerList">
                    <!-- Presets will be populated here -->
                </div>

                <div class="preset-manager-empty" id="presetManagerEmpty" style="display: none;">
                    <p>No saved presets yet.</p>
                    <p>Use the "Save" button in the filters section to create your first preset.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Preset Modal -->
    <div class="preset-modal" id="savePresetModal">
        <div class="preset-modal-content preset-modal-small">
            <div class="preset-modal-header">
                <div class="preset-modal-title">Save Filter Preset</div>
                <button class="preset-modal-close" onclick="closeSavePresetModal()">×</button>
            </div>

            <div class="preset-modal-body">
                <form id="savePresetForm" onsubmit="savePresetSubmit(event)">
                    <div class="form-group">
                        <label for="presetName">Preset Name *</label>
                        <input type="text" id="presetName" required maxlength="50" placeholder="e.g., Favorite Models">
                    </div>

                    <div class="preset-current-filters" id="presetCurrentFilters">
                        <!-- Current filters will be shown here -->
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="setAsDefault">
                            <label for="setAsDefault">Set as default preset</label>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="closeSavePresetModal()">Cancel</button>
                        <button type="submit" class="btn-primary">Save Preset</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let allPosts = [];
        let filteredPosts = [];
        let currentModalIndex = -1;
        let currentMode = 'image';
        let currentVideoIndex = 0;

        // Pagination variables
        let currentPage = 0;
        const pageSize = 50;
        let hasMorePosts = true;
        let isLoading = false;

        // Intersection Observer for infinite scroll
        let scrollObserver = null;

        // AI Model availability status
        let modelStatus = {
            wan: { available: false, installed: false },
            svd: { available: false, installed: false },
            rife: { available: false, installed: false }
        };

        // API Configuration
        // Use shared configuration
        const API_BASE_URL = AppConfig.API_BASE_URL;

        // User Preferences State
        let userPreferences = {
            layout: {
                view_mode: 'masonry',
                density: 'comfortable',
                columns: 'auto'
            },
            filters: {
                last_used: {},
                presets: [],
                default_preset: null
            },
            sorting: {
                default: 'date_desc'
            }
        };

        // Get first user ID (for now, we use the first user in the system)
        let currentUserId = null;

        // Load user preferences from backend
        async function loadPreferences() {
            try {
                // Get first user
                const usersRes = await fetch(`${API_BASE_URL}/api/users`);
                if (!usersRes.ok) {
                    console.warn('Could not fetch users');
                    return;
                }
                const users = await usersRes.json();
                if (users.length === 0) {
                    console.warn('No users found');
                    return;
                }
                currentUserId = users[0].id;

                // Load preferences
                const prefsRes = await fetch(`${API_BASE_URL}/api/users/${currentUserId}/preferences`);
                if (!prefsRes.ok) {
                    console.warn('Could not load preferences');
                    return;
                }
                const prefs = await prefsRes.json();
                userPreferences = prefs.preferences;

                // Apply preferences
                applyPreferences();
                showToast('Preferences loaded', 'success');
            } catch (error) {
                console.error('Error loading preferences:', error);
            }
        }

        // Save user preferences to backend
        async function savePreferences() {
            if (!currentUserId) return;

            try {
                const res = await fetch(`${API_BASE_URL}/api/users/${currentUserId}/preferences`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ preferences: userPreferences })
                });

                if (!res.ok) {
                    throw new Error('Failed to save preferences');
                }
            } catch (error) {
                console.error('Error saving preferences:', error);
                showToast('Failed to save preferences', 'error');
            }
        }

        // Apply loaded preferences to UI
        function applyPreferences() {
            // Apply view mode
            setViewMode(userPreferences.layout.view_mode, false);

            // Apply density
            setDensity(userPreferences.layout.density, false);

            // Apply column count
            const colCount = userPreferences.layout.columns || 'auto';
            document.getElementById('columnCount').value = colCount;
            setColumnCount(colCount, false);

            // Apply sorting
            const sortValue = userPreferences.sorting.default || 'date_desc';
            document.getElementById('sortSelect').value = sortValue;

            // Apply last used filters or default preset
            applyStoredFilters();

            // Update preset count badge
            const presetCount = (userPreferences.filters.presets || []).length;
            document.getElementById('presetCount').textContent = presetCount;
        }

        // Apply stored filters (last used or default preset)
        function applyStoredFilters() {
            let filtersToApply = null;

            // Check if there's a default preset
            if (userPreferences.filters.default_preset) {
                const defaultPreset = userPreferences.filters.presets?.find(
                    p => p.id === userPreferences.filters.default_preset
                );
                if (defaultPreset) {
                    filtersToApply = defaultPreset.filters;
                }
            }

            // If no default preset, use last used filters
            if (!filtersToApply && userPreferences.filters.last_used) {
                filtersToApply = userPreferences.filters.last_used;
            }

            // Apply filters if found
            if (filtersToApply) {
                if (document.getElementById('modeFilter') && filtersToApply.mode) {
                    document.getElementById('modeFilter').value = filtersToApply.mode;
                }
                if (document.getElementById('modelFilter') && filtersToApply.model) {
                    document.getElementById('modelFilter').value = filtersToApply.model;
                }
                if (document.getElementById('searchInput') && filtersToApply.search) {
                    document.getElementById('searchInput').value = filtersToApply.search;
                }
                if (document.getElementById('sortSelect') && filtersToApply.sort) {
                    document.getElementById('sortSelect').value = filtersToApply.sort;
                }
            }
        }

        // Save current filters as last used
        async function saveLastUsedFilters() {
            const currentFilters = getCurrentFilters();
            userPreferences.filters.last_used = currentFilters;
            await savePreferences();
        }

        // Set view mode
        function setViewMode(mode, save = true) {
            // Update button states
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                const isActive = btn.dataset.mode === mode;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-pressed', isActive.toString());
            });

            // Apply to body
            document.body.setAttribute('data-view-mode', mode);

            // Save preference
            if (save) {
                userPreferences.layout.view_mode = mode;
                savePreferences();
                showToast(`View mode: ${mode}`, 'info');
            }
        }

        // Set density
        function setDensity(density, save = true) {
            // Update button states
            document.querySelectorAll('.density-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.density === density);
            });

            // Apply to body
            document.body.setAttribute('data-density', density);

            // Save preference
            if (save) {
                userPreferences.layout.density = density;
                savePreferences();
                showToast(`Density: ${density}`, 'info');
            }
        }

        // Set column count
        function setColumnCount(count, save = true) {
            if (count === 'auto') {
                document.body.removeAttribute('data-manual-columns');
            } else {
                document.body.setAttribute('data-manual-columns', count);
            }

            // Save preference
            if (save) {
                userPreferences.layout.columns = count;
                savePreferences();
            }
        }

        // ===== Filter Preset Functions =====

        // Get current filter state
        function getCurrentFilters() {
            return {
                mode: document.getElementById('modeFilter')?.value || 'all',
                model: document.getElementById('modelFilter')?.value || 'all',
                search: document.getElementById('searchInput')?.value || '',
                sort: document.getElementById('sortSelect')?.value || 'date_desc'
            };
        }

        // Toggle preset dropdown
        function togglePresetDropdown() {
            const dropdown = document.getElementById('presetDropdown');
            const isVisible = dropdown.style.display === 'block';
            dropdown.style.display = isVisible ? 'none' : 'block';

            if (!isVisible) {
                renderPresetList();
            }
        }

        // Render preset list in dropdown
        function renderPresetList() {
            const presetList = document.getElementById('presetList');
            const presets = userPreferences.filters.presets || [];
            const defaultPreset = userPreferences.filters.default_preset;

            if (presets.length === 0) {
                presetList.innerHTML = '<div class="preset-empty">No saved presets yet</div>';
                document.getElementById('presetCount').textContent = '0';
                return;
            }

            document.getElementById('presetCount').textContent = presets.length;

            presetList.innerHTML = presets.map((preset, index) => {
                const isDefault = preset.id === defaultPreset;
                const filterSummary = getFilterSummary(preset.filters);

                return `
                    <div class="preset-item ${isDefault ? 'is-default' : ''}" onclick="applyFilterPreset(${index})">
                        <div class="preset-item-info">
                            <div class="preset-item-name">${preset.name}</div>
                            <div class="preset-item-filters">${filterSummary}</div>
                        </div>
                        <div class="preset-item-actions" onclick="event.stopPropagation()">
                            ${!isDefault ? `<button class="preset-action-btn" onclick="setDefaultPreset(${index})" title="Set as default">⭐</button>` : ''}
                            <button class="preset-action-btn delete" onclick="deleteFilterPreset(${index})" title="Delete">🗑️</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Get filter summary text
        function getFilterSummary(filters) {
            const parts = [];
            if (filters.mode && filters.mode !== 'all') parts.push(`Mode: ${filters.mode}`);
            if (filters.model && filters.model !== 'all') parts.push(`Model: ${filters.model}`);
            if (filters.search) parts.push(`Search: "${filters.search}"`);
            if (filters.sort && filters.sort !== 'date_desc') parts.push(`Sort: ${filters.sort}`);
            return parts.length > 0 ? parts.join(', ') : 'No filters';
        }

        // Open save preset modal
        function saveCurrentPreset() {
            const currentFilters = getCurrentFilters();
            const modal = document.getElementById('savePresetModal');
            const filtersDiv = document.getElementById('presetCurrentFilters');

            // Show current filters
            const summary = getFilterSummary(currentFilters);
            filtersDiv.innerHTML = `
                <div class="preset-current-filters-title">Current Filters:</div>
                <div class="preset-current-filters-list">${summary}</div>
            `;

            // Reset form
            document.getElementById('presetName').value = '';
            document.getElementById('setAsDefault').checked = false;

            // Show modal
            modal.classList.add('active');
        }

        // Close save preset modal
        function closeSavePresetModal() {
            document.getElementById('savePresetModal').classList.remove('active');
        }

        // Submit save preset form
        async function savePresetSubmit(event) {
            event.preventDefault();

            const name = document.getElementById('presetName').value.trim();
            const setDefault = document.getElementById('setAsDefault').checked;
            const currentFilters = getCurrentFilters();

            if (!name) {
                showToast('Please enter a preset name', 'error');
                return;
            }

            // Create new preset
            const newPreset = {
                id: Date.now().toString(),
                name: name,
                filters: currentFilters,
                created_at: new Date().toISOString()
            };

            // Add to presets array
            if (!userPreferences.filters.presets) {
                userPreferences.filters.presets = [];
            }
            userPreferences.filters.presets.push(newPreset);

            // Set as default if requested
            if (setDefault) {
                userPreferences.filters.default_preset = newPreset.id;
            }

            // Save to backend
            await savePreferences();

            // Close modal and refresh UI
            closeSavePresetModal();
            renderPresetList();
            showToast(`Preset "${name}" saved`, 'success');
        }

        // Apply filter preset
        function applyFilterPreset(index) {
            const preset = userPreferences.filters.presets[index];
            if (!preset) return;

            const filters = preset.filters;

            // Apply filters to UI
            if (document.getElementById('modeFilter')) {
                document.getElementById('modeFilter').value = filters.mode || 'all';
            }
            if (document.getElementById('modelFilter')) {
                document.getElementById('modelFilter').value = filters.model || 'all';
            }
            if (document.getElementById('searchInput')) {
                document.getElementById('searchInput').value = filters.search || '';
            }
            if (document.getElementById('sortSelect')) {
                document.getElementById('sortSelect').value = filters.sort || 'date_desc';
            }

            // Close dropdown
            togglePresetDropdown();

            // Apply filters (trigger the existing filter function)
            applyFilters();

            showToast(`Applied preset: ${preset.name}`, 'success');
        }

        // Delete filter preset
        async function deleteFilterPreset(index) {
            const preset = userPreferences.filters.presets[index];
            if (!preset) return;

            if (!confirm(`Delete preset "${preset.name}"?`)) {
                return;
            }

            // Remove from array
            userPreferences.filters.presets.splice(index, 1);

            // Clear default if this was the default preset
            if (userPreferences.filters.default_preset === preset.id) {
                userPreferences.filters.default_preset = null;
            }

            // Save to backend
            await savePreferences();

            // Refresh UI
            renderPresetList();
            showToast(`Preset "${preset.name}" deleted`, 'info');
        }

        // Set preset as default
        async function setDefaultPreset(index) {
            const preset = userPreferences.filters.presets[index];
            if (!preset) return;

            userPreferences.filters.default_preset = preset.id;

            // Save to backend
            await savePreferences();

            // Refresh UI
            renderPresetList();
            showToast(`"${preset.name}" set as default`, 'success');
        }

        // Open preset manager modal
        function openPresetManager() {
            const modal = document.getElementById('presetModal');
            const list = document.getElementById('presetManagerList');
            const empty = document.getElementById('presetManagerEmpty');
            const presets = userPreferences.filters.presets || [];

            if (presets.length === 0) {
                list.style.display = 'none';
                empty.style.display = 'block';
            } else {
                list.style.display = 'block';
                empty.style.display = 'none';
                renderPresetManager();
            }

            modal.classList.add('active');
        }

        // Close preset manager modal
        function closePresetModal() {
            document.getElementById('presetModal').classList.remove('active');
        }

        // Render preset manager list
        function renderPresetManager() {
            const list = document.getElementById('presetManagerList');
            const presets = userPreferences.filters.presets || [];
            const defaultPreset = userPreferences.filters.default_preset;

            list.innerHTML = presets.map((preset, index) => {
                const isDefault = preset.id === defaultPreset;
                const filterSummary = getFilterSummary(preset.filters);

                return `
                    <div class="preset-manager-item ${isDefault ? 'is-default' : ''}">
                        <div class="preset-manager-header">
                            <div class="preset-manager-name">${preset.name}</div>
                            <div class="preset-manager-actions">
                                <button class="preset-manager-btn" onclick="applyFilterPreset(${index}); closePresetModal();">Apply</button>
                                ${!isDefault ? `<button class="preset-manager-btn" onclick="setDefaultPreset(${index})">Set Default</button>` : ''}
                                <button class="preset-manager-btn" onclick="renamePreset(${index})">Rename</button>
                                <button class="preset-manager-btn danger" onclick="deleteFilterPreset(${index})">Delete</button>
                            </div>
                        </div>
                        <div class="preset-manager-filters">${filterSummary}</div>
                    </div>
                `;
            }).join('');
        }

        // Rename preset
        async function renamePreset(index) {
            const preset = userPreferences.filters.presets[index];
            if (!preset) return;

            const newName = prompt('Enter new preset name:', preset.name);
            if (!newName || newName.trim() === '') return;

            preset.name = newName.trim();

            // Save to backend
            await savePreferences();

            // Refresh UI
            renderPresetManager();
            renderPresetList();
            showToast('Preset renamed', 'success');
        }

        // Close preset dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('presetDropdown');
            const btn = document.getElementById('presetDropdownBtn');

            if (dropdown && btn && !dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        // ===== Import JSON Functions =====

        let importData = null;
        let existingPostIds = new Set();

        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
            resetImportSteps();
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
            resetImportSteps();
            importData = null;
            existingPostIds = new Set();
        }

        // Merge Videos Modal Functions
        function openMergeModal() {
            const post = filteredPosts[currentModalIndex];
            const children = post.child_posts || post.children || [];

            if (children.length < 2) {
                showToast('Need at least 2 videos to merge', 'error');
                return;
            }

            // Populate video list with checkboxes
            const videosList = document.getElementById('mergeVideosList');
            videosList.innerHTML = children.map((child, index) => `
                <label style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 6px; cursor: pointer;">
                    <input type="checkbox"
                           class="merge-video-check"
                           data-video-id="${child.id}"
                           data-index="${index}"
                           checked
                           style="width: 18px; height: 18px; cursor: pointer;">
                    <div style="flex: 1;">
                        <div style="font-weight: 500;">Video ${index + 1}</div>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">
                            ${child.mode || 'normal'} mode
                        </div>
                    </div>
                    <div style="color: rgba(255,255,255,0.5); font-size: 0.85rem;">
                        ${child.model_name || 'unknown'}
                    </div>
                </label>
            `).join('');

            document.getElementById('mergeVideosModal').style.display = 'flex';
        }

        function closeMergeModal() {
            document.getElementById('mergeVideosModal').style.display = 'none';
        }

        async function executeMergeVideos() {
            // Get selected video IDs
            const checkboxes = document.querySelectorAll('.merge-video-check:checked');
            const videoIds = Array.from(checkboxes).map(cb => cb.dataset.videoId);

            if (videoIds.length < 2) {
                showToast('Select at least 2 videos to merge', 'error');
                return;
            }

            const useTransitions = document.getElementById('useTransitionsCheck').checked;
            const transitionFrames = parseInt(document.getElementById('transitionFramesSlider').value);

            // Check if RIFE is available when transitions are requested
            if (useTransitions && !modelStatus.rife.installed) {
                const confirmed = confirm(
                    `AI transitions require the RIFE model (~800MB).\n\n` +
                    `The model is not currently installed.\n\n` +
                    `Options:\n` +
                    `• Click OK to proceed with simple merge (no transitions)\n` +
                    `• Click Cancel to abort\n\n` +
                    `Note: RIFE model auto-installation is not yet implemented.`
                );

                if (!confirmed) {
                    return; // User cancelled
                }

                // Proceed with simple merge instead
                document.getElementById('useTransitionsCheck').checked = false;
                showToast('Proceeding with simple merge (RIFE not available)', 'info');
            }

            closeMergeModal();

            const mergeBtn = document.getElementById('mergeVideosBtn');
            const originalText = mergeBtn.innerHTML;

            try {
                mergeBtn.disabled = true;
                mergeBtn.innerHTML = '⏳ Merging...';

                const timeEstimate = useTransitions
                    ? `5-15 minutes (AI transitions)`
                    : `< 1 minute (simple concat)`;

                showToast(`Merging ${videoIds.length} videos... This will take ${timeEstimate}`, 'info');

                const response = await fetch(`${API_BASE_URL}/api/videos/merge`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        video_ids: videoIds,
                        use_transitions: useTransitions,
                        transition_frames: transitionFrames,
                        fps: 30
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Merge failed');
                }

                const result = await response.json();

                showToast(`Videos merged successfully!${useTransitions ? ' with AI transitions' : ''}`, 'success');

                // Reload posts to show new merged video
                await loadPosts();
                renderModalContent();

            } catch (error) {
                console.error('Video merge error:', error);
                showToast(`Failed to merge videos: ${error.message}`, 'error');
            } finally {
                mergeBtn.disabled = false;
                mergeBtn.innerHTML = originalText;
            }
        }

        function resetImportSteps() {
            document.getElementById('importStep1').style.display = 'block';
            document.getElementById('importStep2').style.display = 'none';
            document.getElementById('importStep3').style.display = 'none';
            document.getElementById('importStep4').style.display = 'none';
            document.getElementById('importStep5').style.display = 'none';
            document.getElementById('jsonFileInput').value = '';
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    importData = jsonData;
                    analyzeImportData(jsonData);
                } catch (error) {
                    showToast('Invalid JSON file', 'error');
                    console.error('Error parsing JSON:', error);
                }
            };
            reader.readAsText(file);
        }

        async function analyzeImportData(data) {
            // Count total posts
            const totalPosts = data.length;
            let totalChildPosts = 0;
            data.forEach(post => {
                totalChildPosts += (post.childPosts || []).length;
            });

            // Validate import data (check existing posts and missing files)
            existingPostIds = new Set(); // Reset global variable
            let validationResult = null;

            try {
                const response = await fetch(`${API_BASE_URL}/api/import/validate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ posts: data })
                });

                if (response.ok) {
                    validationResult = await response.json();
                    console.log('Validation result:', validationResult);
                }
            } catch (error) {
                console.error('Error validating import:', error);
                showToast('Warning: Could not validate import data', 'warning');
            }

            const existingCount = validationResult ? validationResult.existing_posts : 0;
            const newCount = validationResult ? validationResult.new_posts : totalPosts;
            const missingFilesCount = validationResult ? validationResult.missing_files.length : 0;
            const canImport = validationResult ? validationResult.can_import : false;

            // Store missing files globally
            window.missingMediaFiles = validationResult ? validationResult.missing_files : [];

            // Update UI
            document.getElementById('importTotalPosts').textContent = totalPosts;
            document.getElementById('importNewPosts').textContent = newCount;
            document.getElementById('importExistingPosts').textContent = existingCount;
            document.getElementById('importChildPosts').textContent = totalChildPosts;
            document.getElementById('importVideosToDownload').textContent = missingFilesCount;

            // Update button states based on validation
            const downloadBtn = document.querySelector('[onclick="generateDownloadList()"]');
            const importBtn = document.querySelector('[onclick="proceedToImport()"]');

            if (downloadBtn && importBtn) {
                if (missingFilesCount > 0) {
                    downloadBtn.style.display = 'inline-block';
                    importBtn.disabled = true;
                    importBtn.title = 'Download missing files first';
                    showToast(`${missingFilesCount} media files need to be downloaded first`, 'warning');
                } else {
                    downloadBtn.style.display = 'none';
                    importBtn.disabled = false;
                    importBtn.title = '';
                    if (newCount > 0) {
                        showToast('All media files are available locally! Ready to import.', 'success');
                    }
                }
            }

            // Show step 2
            document.getElementById('importStep1').style.display = 'none';
            document.getElementById('importStep2').style.display = 'block';
        }

        function generateDownloadList() {
            if (!window.missingMediaFiles || window.missingMediaFiles.length === 0) {
                showToast('No files to download!', 'info');
                return;
            }

            // Show missing files list
            document.getElementById('downloadUrlsList').value = window.missingMediaFiles.join('\n');
            document.getElementById('importStep2').style.display = 'none';
            document.getElementById('importStep4').style.display = 'block';
        }

        function copyDownloadList() {
            const textarea = document.getElementById('downloadUrlsList');
            textarea.select();
            document.execCommand('copy');
            showToast('URLs copied to clipboard!', 'success');
        }

        function downloadUrlsAsFile() {
            const urls = document.getElementById('downloadUrlsList').value;
            const blob = new Blob([urls], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `video_download_urls_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Download list saved!', 'success');
        }

        async function startImport() {
            if (!importData) return;

            // Show progress
            document.getElementById('importStep2').style.display = 'none';
            document.getElementById('importStep4').style.display = 'none';
            document.getElementById('importStep3').style.display = 'block';

            try {
                const response = await fetch(`${API_BASE_URL}/api/import`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ posts: importData })
                });

                if (!response.ok) {
                    throw new Error('Import failed');
                }

                const result = await response.json();

                // Show completion
                document.getElementById('importStep3').style.display = 'none';
                document.getElementById('importStep5').style.display = 'block';

                document.getElementById('importResults').innerHTML = `
                    <p><strong>✅ Import Successful!</strong></p>
                    <p>• Media Posts Imported: ${result.posts_imported || 0}</p>
                    <p>• Child Posts Imported: ${result.child_posts_imported || 0}</p>
                    <p>• Skipped (Already Exist): ${result.posts_skipped || 0}</p>
                `;

                showToast('Import completed successfully!', 'success');
            } catch (error) {
                console.error('Import error:', error);
                showToast('Import failed: ' + error.message, 'error');
                document.getElementById('importStep3').style.display = 'none';
                document.getElementById('importStep2').style.display = 'block';
            }
        }

        // Toast Notification System
        // Use SharedUtils.showToast() from shared-utils.js
        const showToast = SharedUtils.showToast;

        // Touch/Swipe Gesture Handler for Modal
        let touchStartX = 0;
        let touchStartY = 0;

        function setupSwipeGestures() {
            const modal = document.getElementById('modal');

            modal.addEventListener('touchstart', e => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }, { passive: true });

            modal.addEventListener('touchend', e => {
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const diffX = touchStartX - touchEndX;
                const diffY = touchStartY - touchEndY;

                // Check if horizontal swipe is dominant
                if (Math.abs(diffX) > Math.abs(diffY)) {
                    if (Math.abs(diffX) > 50) { // Minimum swipe distance
                        if (diffX > 0) {
                            navigateInModal(1); // Swipe left = next
                        } else {
                            navigateInModal(-1); // Swipe right = previous
                        }
                    }
                }
            }, { passive: true });
        }

        // Focus Trap for Modal
        function trapFocus(element) {
            const focusableElements = element.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];

            const handleTab = (e) => {
                if (e.key === 'Tab') {
                    if (e.shiftKey && document.activeElement === firstElement) {
                        lastElement.focus();
                        e.preventDefault();
                    } else if (!e.shiftKey && document.activeElement === lastElement) {
                        firstElement.focus();
                        e.preventDefault();
                    }
                }
            };

            element.addEventListener('keydown', handleTab);

            // Focus first element when modal opens
            if (firstElement) firstElement.focus();

            return () => element.removeEventListener('keydown', handleTab);
        }

        // Stub for removed StudioNav component (was in navigation.js)
        const StudioNav = {
            init: () => {},
            loadGlobalStats: () => {},
            updateBreadcrumb: () => {}
        };

        // Fetch initial data
        function saveModelPreference() {
            const modelSelector = document.getElementById('modelSelector');
            if (modelSelector) {
                localStorage.setItem('preferredVideoModel', modelSelector.value);
            }
        }

        function loadModelPreference() {
            const modelSelector = document.getElementById('modelSelector');
            const preferred = localStorage.getItem('preferredVideoModel');
            if (modelSelector && preferred) {
                modelSelector.value = preferred;
            }
        }

        async function checkModelAvailability() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/models/status`);
                const status = await response.json();

                // Update global model status
                modelStatus.wan = status.wan || modelStatus.wan;
                modelStatus.svd = status.svd || modelStatus.svd;
                modelStatus.rife = status.rife || modelStatus.rife;

                // Update model selector dropdown to disable unavailable models
                const modelSelector = document.getElementById('modelSelector');
                if (modelSelector) {
                    const options = modelSelector.options;
                    for (let i = 0; i < options.length; i++) {
                        const option = options[i];
                        const modelKey = option.value;

                        if (modelStatus[modelKey] && !modelStatus[modelKey].installed) {
                            option.disabled = true;
                            option.text = option.text.replace(')', `, ${modelStatus[modelKey].size_gb || modelStatus[modelKey].size_mb}GB download required)`);
                        }
                    }
                }

                // Log model status for debugging
                console.log('AI Model Status:', status);

                // Show warning if no models are installed
                if (!modelStatus.wan.installed && !modelStatus.svd.installed) {
                    console.warn('No AI models installed for video generation. Models will be downloaded on first use.');
                }

                return status;
            } catch (error) {
                console.error('Failed to check model availability:', error);
                return null;
            }
        }

        async function init() {
            // Initialize unified navigation (no-op stub)
            StudioNav.init({
                showBreadcrumbs: true
            });

            // Handle URL parameters for cross-page navigation
            const urlParams = new URLSearchParams(window.location.search);
            const searchParam = urlParams.get('search');
            const typeParam = urlParams.get('type');
            const likedParam = urlParams.get('liked');

            try {
                // Fetch stats
                const statsRes = await fetch(`${API_BASE_URL}/api/stats`);
                const stats = await statsRes.json();

                // Stats are now handled by the unified navigation component
                // No need to update them here since StudioNav.loadGlobalStats() handles it

                // Fetch models
                const modelsRes = await fetch(`${API_BASE_URL}/api/models`);
                const modelsData = await modelsRes.json();
                const models = modelsData.models || modelsData;

                const modelSelect = document.getElementById('modelFilter');
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name || model;
                    option.textContent = model.name || model;
                    modelSelect.appendChild(option);
                });

                // Check AI model availability for video generation
                await checkModelAvailability();

                // Fetch media posts
                await loadPosts();

                // Setup filters
                document.getElementById('typeFilter').addEventListener('change', applyFilters);
                document.getElementById('likedFilter').addEventListener('change', applyFilters);
                document.getElementById('modelFilter').addEventListener('change', applyFilters);
                document.getElementById('modeFilter').addEventListener('change', applyFilters);
                document.getElementById('hasCustomVideosFilter').addEventListener('change', applyFilters);
                document.getElementById('searchInput').addEventListener('input', applyFilters);

                // Setup view controls
                document.getElementById('sortSelect').addEventListener('change', () => {
                    userPreferences.sorting.default = document.getElementById('sortSelect').value;
                    savePreferences();
                    applyFilters();
                });

                document.getElementById('columnCount').addEventListener('change', (e) => {
                    setColumnCount(e.target.value, true);
                });

                // Load user preferences
                await loadPreferences();

                // Apply URL parameters (override saved preferences for this session)
                if (searchParam) {
                    document.getElementById('searchInput').value = searchParam;
                    StudioNav.updateBreadcrumb(`Search: "${searchParam}"`);
                }
                if (typeParam) {
                    document.getElementById('typeFilter').value = typeParam;
                }
                if (likedParam === 'true') {
                    document.getElementById('likedFilter').value = 'liked';
                }

                // Apply filters if URL params were set
                if (searchParam || typeParam || likedParam) {
                    applyFilters();
                }

                // Keyboard navigation
                document.addEventListener('keydown', handleKeyboard);

                // Setup swipe gestures for mobile
                setupSwipeGestures();

                // Setup infinite scroll
                setupInfiniteScroll();

            } catch (error) {
                console.error('Error initializing:', error);
                const errorMsg = error.message || 'Unknown error occurred';
                document.getElementById('galleryGrid').innerHTML =
                    `<div class="empty" role="alert">Error loading gallery: ${errorMsg}. <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #667eea; border: none; color: white; border-radius: 6px; cursor: pointer;">Retry</button></div>`;
                showToast('Failed to load gallery. Please check your connection.', 'error');
            }
        }

        // Setup Intersection Observer for infinite scroll
        function setupInfiniteScroll() {
            const sentinel = document.getElementById('scrollSentinel');

            if (!sentinel) return;

            // Disconnect previous observer if it exists
            if (scrollObserver) {
                scrollObserver.disconnect();
            }

            // Create new observer with 200px rootMargin to trigger before reaching the bottom
            scrollObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    // When sentinel becomes visible and we have more posts
                    if (entry.isIntersecting && hasMorePosts && !isLoading) {
                        loadMorePosts();
                    }
                });
            }, {
                root: null, // viewport
                rootMargin: '200px', // trigger 200px before reaching sentinel
                threshold: 0
            });

            scrollObserver.observe(sentinel);
        }

        async function loadPosts(append = false) {
            if (isLoading) return;
            isLoading = true;

            // Show loading skeletons if not appending
            if (!append) {
                const grid = document.getElementById('galleryGrid');
                grid.innerHTML = Array(6).fill(0).map(() =>
                    '<div class="skeleton-card" aria-hidden="true"></div>'
                ).join('');
            }

            try {
                const type = document.getElementById('typeFilter').value;
                const liked = document.getElementById('likedFilter').value;
                const model = document.getElementById('modelFilter').value;
                const mode = document.getElementById('modeFilter').value;
                const hasCustomVideos = document.getElementById('hasCustomVideosFilter').checked;
                const search = document.getElementById('searchInput').value;
                const sort = document.getElementById('sortSelect')?.value || 'date_desc';

                const params = new URLSearchParams({
                    type,
                    liked,
                    model,
                    mode,
                    search,
                    sort,
                    skip: currentPage * pageSize,
                    limit: pageSize
                });

                // Only add hasCustomVideos param if checked
                if (hasCustomVideos) {
                    params.append('has_custom_videos', 'true');
                }

                const response = await fetch(`${API_BASE_URL}/api/media?${params}`);
                const data = await response.json();

                if (append) {
                    allPosts = [...allPosts, ...data];
                    filteredPosts = [...filteredPosts, ...data];
                } else {
                    allPosts = data;
                    filteredPosts = data;
                    currentPage = 0;
                }

                hasMorePosts = data.length === pageSize;
                renderGallery();
            } catch (error) {
                console.error('Error loading posts:', error);
                showToast('Failed to load posts. Please try again.', 'error');
                // Show error in gallery if no posts loaded
                if (!append && filteredPosts.length === 0) {
                    document.getElementById('galleryGrid').innerHTML =
                        '<div class="empty" role="alert">Failed to load posts. <button onclick="loadPosts()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #667eea; border: none; color: white; border-radius: 6px; cursor: pointer;">Retry</button></div>';
                }
            } finally {
                isLoading = false;
                updateInfiniteScrollUI();
            }
        }

        function loadMorePosts() {
            currentPage++;
            loadPosts(true);
        }

        function updateInfiniteScrollUI() {
            const loadingIndicator = document.getElementById('infiniteScrollLoading');
            const noMorePostsMsg = document.getElementById('noMorePosts');

            if (isLoading) {
                // Show loading spinner
                loadingIndicator?.classList.add('visible');
                noMorePostsMsg?.classList.remove('visible');
            } else {
                // Hide loading spinner
                loadingIndicator?.classList.remove('visible');

                // Show "no more posts" message if we've reached the end
                if (!hasMorePosts && filteredPosts.length > 0) {
                    noMorePostsMsg?.classList.add('visible');
                } else {
                    noMorePostsMsg?.classList.remove('visible');
                }
            }
        }

        function updateFilterChips() {
            const chips = [];
            const typeFilter = document.getElementById('typeFilter').value;
            const likedFilter = document.getElementById('likedFilter').value;
            const modelFilter = document.getElementById('modelFilter').value;
            const modeFilter = document.getElementById('modeFilter').value;
            const hasCustomVideos = document.getElementById('hasCustomVideosFilter').checked;
            const searchInput = document.getElementById('searchInput').value;

            // Add chips for each active filter
            if (typeFilter !== 'all') {
                chips.push({ label: `Type: ${typeFilter}`, filter: 'typeFilter', value: 'all' });
            }
            if (likedFilter !== 'all') {
                chips.push({ label: 'Liked Only', filter: 'likedFilter', value: 'all' });
            }
            if (modelFilter !== 'all') {
                const modelName = document.getElementById('modelFilter').options[document.getElementById('modelFilter').selectedIndex].text;
                chips.push({ label: `Model: ${modelName}`, filter: 'modelFilter', value: 'all' });
            }
            if (modeFilter !== 'all') {
                chips.push({ label: `Mode: ${modeFilter}`, filter: 'modeFilter', value: 'all' });
            }
            if (hasCustomVideos) {
                chips.push({ label: 'Has Custom Videos', filter: 'hasCustomVideosFilter', value: false });
            }
            if (searchInput) {
                chips.push({ label: `Search: "${searchInput}"`, filter: 'searchInput', value: '' });
            }

            // Update UI
            const chipsContainer = document.getElementById('filterChips');
            const activeFiltersSection = document.getElementById('activeFilters');
            const clearAllButton = document.getElementById('clearAllFilters');

            if (chips.length > 0) {
                chipsContainer.innerHTML = chips.map(chip => `
                    <div class="filter-chip" role="listitem">
                        <span>${chip.label}</span>
                        <button class="filter-chip-remove"
                                onclick="removeFilter('${chip.filter}', ${typeof chip.value === 'string' ? `'${chip.value}'` : chip.value})"
                                aria-label="Remove ${chip.label} filter">
                            ×
                        </button>
                    </div>
                `).join('');
                activeFiltersSection.classList.add('visible');
                clearAllButton.style.display = 'inline-block';
            } else {
                activeFiltersSection.classList.remove('visible');
                clearAllButton.style.display = 'none';
            }
        }

        function removeFilter(filterId, resetValue) {
            const element = document.getElementById(filterId);
            if (element.type === 'checkbox') {
                element.checked = resetValue;
            } else {
                element.value = resetValue;
            }
            applyFilters();
        }

        function clearAllFilters() {
            document.getElementById('typeFilter').value = 'all';
            document.getElementById('likedFilter').value = 'all';
            document.getElementById('modelFilter').value = 'all';
            document.getElementById('modeFilter').value = 'all';
            document.getElementById('hasCustomVideosFilter').checked = false;
            document.getElementById('searchInput').value = '';
            applyFilters();
        }

        function applyFilters() {
            updateFilterChips();
            currentPage = 0; // Reset pagination
            loadPosts();
            // Re-setup infinite scroll observer after filter change
            setTimeout(() => setupInfiniteScroll(), 100);
            // Save last used filters
            saveLastUsedFilters();
        }

        // Utility: Copy to clipboard
        async function copyToClipboard(text, event) {
            event.stopPropagation();
            try {
                await navigator.clipboard.writeText(text);
                showToast('Prompt copied to clipboard!', 'success');
            } catch (err) {
                showToast('Failed to copy prompt', 'error');
            }
        }

        // Utility: Download image
        function downloadImage(url, event) {
            event.stopPropagation();
            const link = document.createElement('a');
            link.href = url;
            link.download = `media_${Date.now()}.jpg`;
            link.click();
            showToast('Download started', 'success');
        }

        function quickGenerateVideo(postId, event) {
            event.stopPropagation();
            // Find the post index
            const index = filteredPosts.findIndex(p => p.id === postId);
            if (index !== -1) {
                // Open modal at this post
                openModal(index);
                // Wait a bit for modal to render, then click generate button
                setTimeout(() => {
                    const generateBtn = document.getElementById('generateVideoBtn');
                    if (generateBtn && !generateBtn.disabled) {
                        generateBtn.click();
                    }
                }, 100);
            }
        }

        function quickMergeVideos(postId, event) {
            event.stopPropagation();
            // Find the post index
            const index = filteredPosts.findIndex(p => p.id === postId);
            if (index !== -1) {
                // Open modal at this post
                openModal(index);
                // Wait a bit for modal to render, then open merge modal
                setTimeout(() => {
                    const mergeBtn = document.getElementById('mergeVideosBtn');
                    if (mergeBtn && !mergeBtn.disabled) {
                        mergeBtn.click();
                    }
                }, 100);
            }
        }

        function handleImageError(img, hasVideo) {
            // If image fails to load and there's a video, show the video instead
            if (hasVideo) {
                const video = img.nextElementSibling;
                if (video && video.tagName === 'VIDEO') {
                    img.style.display = 'none';
                    video.style.display = 'block';
                    // Load the video if it hasn't been loaded yet
                    if (video.dataset.src && !video.src) {
                        video.src = video.dataset.src;
                        video.load();
                    }
                    return;
                }
            }
            // If no video available, hide the entire gallery item
            const galleryItem = img.closest('.gallery-item');
            if (galleryItem) {
                galleryItem.style.display = 'none';
            }
        }

        function renderGallery() {
            const grid = document.getElementById('galleryGrid');

            if (filteredPosts.length === 0) {
                grid.innerHTML = '<div class="empty">No posts found matching your filters.</div>';
                updateLoadedCount();
                return;
            }

            grid.innerHTML = filteredPosts.map((post, index) => {
                const children = post.child_posts || post.children || [];
                const videoCount = children.length;
                const firstVideo = videoCount > 0 ? children[0] : null;
                const altText = post.prompt || `AI generated image by ${post.model_name || 'Unknown model'}`;
                const animationDelay = (index % 10) * 0.05; // Stagger animation
                return `
                <div class="gallery-item"
                     data-index="${index}"
                     data-id="${post.id}"
                     onclick="openModal(${index})"
                     role="listitem"
                     tabindex="0"
                     onkeypress="if(event.key==='Enter')openModal(${index})"
                     aria-label="Open ${altText}"
                     style="animation-delay: ${animationDelay}s">
                    <input type="checkbox"
                           class="compare-checkbox"
                           onclick="toggleComparison(${index}, event)"
                           aria-label="Select for comparison">

                    <img src="${post.local_file_path || post.media_url}"
                         alt="${altText}"
                         loading="lazy"
                         onerror="handleImageError(this, ${!!firstVideo})">

                    ${firstVideo ? `
                    <video
                        class="gallery-video"
                        muted
                        loop
                        playsinline
                        preload="metadata"
                        data-src="${firstVideo.local_file_path || firstVideo.media_url}"
                        style="display: none;">
                    </video>
                    ` : ''}

                    ${videoCount > 0 ?
                        `<div class="video-badge" aria-label="${videoCount} generated video${videoCount !== 1 ? 's' : ''}">${videoCount} video${videoCount !== 1 ? 's' : ''}</div>` : ''}

                    <div class="add-to-collection-btn" onclick="toggleCollectionDropdown('${post.id}', event)" title="Add to collection">
                        📁 <span id="collection-count-${post.id}"></span>
                        <div class="collection-dropdown" id="dropdown-${post.id}"></div>
                    </div>

                    <div class="gallery-item-overlay">
                        <div class="overlay-top">
                            <button class="quick-action" onclick="copyToClipboard(\`${post.prompt.replace(/`/g, '\\`')}\`, event)" aria-label="Copy prompt" title="Copy prompt">
                                📋
                            </button>
                            <button class="quick-action" onclick="downloadImage('${post.media_url}', event)" aria-label="Download" title="Download">
                                ⬇️
                            </button>
                            ${(post.media_type === 'image' || post.media_type.includes('IMAGE')) ? `
                            <button class="quick-action" onclick="quickGenerateVideo('${post.id}', event)" aria-label="Generate video" title="Generate video from image">
                                🎬
                            </button>
                            ` : ''}
                            ${videoCount >= 2 ? `
                            <button class="quick-action" onclick="quickMergeVideos('${post.id}', event)" aria-label="Merge videos" title="Merge ${videoCount} videos">
                                🎞️
                            </button>
                            ` : ''}
                        </div>
                        <div class="overlay-bottom">
                            <div class="item-prompt">${post.prompt || 'No prompt available'}</div>
                            <div class="item-meta">
                                <span>${post.model_name || 'Unknown'}</span>
                                <span>${new Date(post.create_time).toLocaleDateString()}</span>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            updateLoadedCount();

            // Setup video hover previews after rendering
            setupVideoHoverPreviews();

            // Initialize collection badges
            initializeCollectionBadges();

            // Enhance gallery cards with prompt actions
            enhanceGalleryCardsWithPrompts();
        }

        function updateLoadedCount() {
            const loadedSpan = document.getElementById('loadedCount');
            if (loadedSpan) {
                const count = filteredPosts.length;
                loadedSpan.textContent = hasMorePosts ?
                    `Showing ${count} posts` :
                    `${count} post${count !== 1 ? 's' : ''}`;
            }
        }

        // Video hover preview functionality
        let videoPreviewObserver = null;
        let hoverTimeouts = new Map();

        // Similar items cache
        let similarItemsCache = new Map();

        // Comparison mode
        let comparisonItems = [];

        // Collections
        let allCollections = [];
        let currentEditingCollectionId = null;

        function setupVideoHoverPreviews() {
            // Disconnect previous observer if exists
            if (videoPreviewObserver) {
                videoPreviewObserver.disconnect();
            }

            // Observe gallery items for lazy loading video sources
            videoPreviewObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const item = entry.target;
                        const video = item.querySelector('.gallery-video');

                        if (video && video.dataset.src && !video.src) {
                            // Lazy load video source
                            video.src = video.dataset.src;
                            video.load();

                            // Setup hover handlers for desktop
                            setupItemHoverHandlers(item, video);

                            // Setup touch handlers for mobile
                            setupItemTouchHandlers(item, video);
                        }

                        // Stop observing this item once loaded
                        videoPreviewObserver.unobserve(item);
                    }
                });
            }, {
                root: null,
                rootMargin: '50px',
                threshold: 0.1
            });

            // Observe all gallery items with videos
            const galleryItems = document.querySelectorAll('.gallery-item');
            galleryItems.forEach(item => {
                const video = item.querySelector('.gallery-video');
                if (video) {
                    videoPreviewObserver.observe(item);
                }
            });
        }

        function setupItemHoverHandlers(item, video) {
            // Desktop: mouse enter/leave
            item.addEventListener('mouseenter', () => {
                const timeout = setTimeout(() => {
                    playVideoPreview(item, video);
                }, 100); // 100ms debounce
                hoverTimeouts.set(item, timeout);
            });

            item.addEventListener('mouseleave', () => {
                // Clear timeout if mouse leaves before video starts
                const timeout = hoverTimeouts.get(item);
                if (timeout) {
                    clearTimeout(timeout);
                    hoverTimeouts.delete(item);
                }
                pauseVideoPreview(item, video);
            });
        }

        function setupItemTouchHandlers(item, video) {
            let touchTimeout = null;

            item.addEventListener('touchstart', (e) => {
                // Don't prevent default - we still want clicks to work
                touchTimeout = setTimeout(() => {
                    playVideoPreview(item, video);
                }, 100);
            }, { passive: true });

            item.addEventListener('touchend', (e) => {
                if (touchTimeout) {
                    clearTimeout(touchTimeout);
                }
                // Pause after 500ms to allow user to see preview
                setTimeout(() => {
                    pauseVideoPreview(item, video);
                }, 500);
            }, { passive: true });

            item.addEventListener('touchcancel', () => {
                if (touchTimeout) {
                    clearTimeout(touchTimeout);
                }
                pauseVideoPreview(item, video);
            }, { passive: true });
        }

        function playVideoPreview(item, video) {
            if (!video || !video.src) return;

            item.classList.add('video-playing');
            video.play().catch(err => {
                // Ignore play errors (common on mobile Safari)
                console.debug('Video preview play failed:', err);
            });
        }

        function pauseVideoPreview(item, video) {
            if (!video) return;

            item.classList.remove('video-playing');
            video.pause();
            video.currentTime = 0; // Reset to beginning
        }

        // Similar items functionality
        async function loadSimilarItems(postId) {
            const similarSection = document.getElementById('similarItems');
            const contentDiv = document.getElementById('similarItemsContent');

            // Show section
            similarSection.style.display = 'block';

            // Check cache first
            if (similarItemsCache.has(postId)) {
                renderSimilarItems(similarItemsCache.get(postId));
                return;
            }

            // Show loading state
            contentDiv.innerHTML = '<div class="similar-items-loading">Finding similar items...</div>';

            try {
                const response = await fetch(`${API_BASE_URL}/api/media/${postId}/similar?limit=6`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const similarPosts = await response.json();

                // Cache the results
                similarItemsCache.set(postId, similarPosts);

                // Render similar items
                renderSimilarItems(similarPosts);
            } catch (error) {
                console.error('Error loading similar items:', error);
                contentDiv.innerHTML = '<div class="similar-items-empty">Unable to load similar items</div>';
            }
        }

        function renderSimilarItems(posts) {
            const contentDiv = document.getElementById('similarItemsContent');

            if (!posts || posts.length === 0) {
                contentDiv.innerHTML = '<div class="similar-items-empty">No similar items found</div>';
                return;
            }

            // Find indices of similar posts in filteredPosts
            const similarItems = posts.map(post => {
                const index = filteredPosts.findIndex(p => p.id === post.id);
                return { post, index };
            }).filter(item => item.index !== -1); // Only include items that exist in current filtered view

            contentDiv.innerHTML = `
                <div class="similar-items-carousel">
                    ${similarItems.map(({ post, index }) => `
                        <div class="similar-item" onclick="navigateToSimilarItem(${index})" role="button" tabindex="0">
                            <img src="${post.local_file_path || post.media_url}"
                                 alt="${post.prompt || 'Similar item'}"
                                 loading="lazy"
                                 onerror="this.src='${post.media_url}'">
                            <div class="similar-item-info" title="${post.prompt || 'No prompt'}">
                                ${post.model_name || 'Unknown'}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function navigateToSimilarItem(index) {
            currentModalIndex = index;
            currentVideoIndex = 0;

            // Auto-switch mode based on content
            const post = filteredPosts[index];
            const children = post.child_posts || post.children || [];
            currentMode = children.length > 0 ? 'video' : 'image';

            renderModalContent();

            // Scroll modal to top for better UX
            const modalViewer = document.querySelector('.modal-viewer');
            if (modalViewer) {
                modalViewer.scrollTop = 0;
            }
        }

        // Comparison mode functions
        function toggleComparison(index, event) {
            event.stopPropagation(); // Prevent opening modal

            const post = filteredPosts[index];
            const existingIndex = comparisonItems.findIndex(item => item.id === post.id);

            if (existingIndex !== -1) {
                // Remove from comparison
                comparisonItems.splice(existingIndex, 1);
            } else {
                // Add to comparison (max 4 items)
                if (comparisonItems.length >= 4) {
                    showToast('Maximum 4 items can be compared', 'error');
                    event.target.checked = false;
                    return;
                }
                comparisonItems.push(post);
            }

            updateComparisonBar();
        }

        function updateComparisonBar() {
            const bar = document.getElementById('comparisonBar');
            const count = document.getElementById('comparisonCount');
            const itemsContainer = document.getElementById('comparisonItems');
            const compareBtn = document.getElementById('compareNowBtn');
            const bulkCollectionBtn = document.getElementById('bulkCollectionBtn');

            // Update count
            count.textContent = `${comparisonItems.length} item${comparisonItems.length !== 1 ? 's' : ''} selected`;

            // Update thumbnails
            itemsContainer.innerHTML = comparisonItems.map(post => `
                <img src="${post.local_file_path || post.media_url}"
                     alt="${post.prompt || 'Comparison item'}"
                     class="comparison-item-thumb">
            `).join('');

            // Show/hide bar
            if (comparisonItems.length > 0) {
                bar.classList.add('visible');
                compareBtn.disabled = comparisonItems.length < 2;
                bulkCollectionBtn.disabled = false;
            } else {
                bar.classList.remove('visible');
            }

            // Update checkboxes in gallery
            document.querySelectorAll('.compare-checkbox').forEach((checkbox, index) => {
                const post = filteredPosts[index];
                checkbox.checked = comparisonItems.some(item => item.id === post.id);
            });
        }

        function clearComparison() {
            comparisonItems = [];
            updateComparisonBar();
        }

        function openComparisonModal() {
            if (comparisonItems.length < 2) {
                showToast('Please select at least 2 items to compare', 'error');
                return;
            }

            const modal = document.getElementById('comparisonModal');
            modal.classList.add('active');

            renderComparisonGrid();
            renderComparisonTable();

            // Initialize grid with default columns
            updateComparisonColumns();

            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        function closeComparisonModal() {
            const modal = document.getElementById('comparisonModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';

            // Pause all videos when closing
            pauseAllComparisonVideos();

            // Reset sort to default
            document.getElementById('comparisonSort').value = 'default';
            originalComparisonOrder = [];
        }

        function updateComparisonColumns() {
            const select = document.getElementById('comparisonColumns');
            const grid = document.getElementById('comparisonGrid');
            const columns = select.value;

            grid.setAttribute('data-columns', columns);
        }

        function setComparisonViewMode(mode) {
            const grid = document.getElementById('comparisonGrid');
            const buttons = document.querySelectorAll('.comparison-controls .view-mode-btn');

            // Update button states
            buttons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            // Update grid view mode
            grid.setAttribute('data-view-mode', mode);

            showToast(`View: ${mode}`, 'info');
        }

        let originalComparisonOrder = [];

        function sortComparisonItems() {
            const sortSelect = document.getElementById('comparisonSort');
            const sortBy = sortSelect.value;

            // Store original order on first sort
            if (originalComparisonOrder.length === 0) {
                originalComparisonOrder = [...comparisonItems];
            }

            // Sort the comparison items
            if (sortBy === 'default') {
                comparisonItems = [...originalComparisonOrder];
            } else if (sortBy === 'date_desc') {
                comparisonItems.sort((a, b) => new Date(b.create_time) - new Date(a.create_time));
            } else if (sortBy === 'date_asc') {
                comparisonItems.sort((a, b) => new Date(a.create_time) - new Date(b.create_time));
            } else if (sortBy === 'model') {
                comparisonItems.sort((a, b) => {
                    const modelA = (a.model_name || 'Unknown').toLowerCase();
                    const modelB = (b.model_name || 'Unknown').toLowerCase();
                    return modelA.localeCompare(modelB);
                });
            } else if (sortBy === 'prompt') {
                comparisonItems.sort((a, b) => {
                    const promptA = (a.prompt || '').toLowerCase();
                    const promptB = (b.prompt || '').toLowerCase();
                    return promptA.localeCompare(promptB);
                });
            }

            // Re-render with new order
            renderComparisonGrid();
            renderComparisonTable();
            updateComparisonColumns(); // Reapply column setting
        }

        function playAllComparisonVideos() {
            const videos = document.querySelectorAll('.comparison-cell-video');
            const containers = document.querySelectorAll('.comparison-cell-media-container');

            videos.forEach((video, index) => {
                const container = containers[index];
                const img = container?.querySelector('.comparison-cell-media');

                if (video && container && img) {
                    // Lock video visible
                    container.dataset.locked = 'true';
                    video.style.setProperty('opacity', '1', 'important');
                    img.style.setProperty('opacity', '0', 'important');
                    video.play().catch(err => {
                        console.debug('Video play failed:', err);
                    });
                }
            });

            showToast('Playing all videos', 'success');
        }

        function pauseAllComparisonVideos() {
            const videos = document.querySelectorAll('.comparison-cell-video');
            const containers = document.querySelectorAll('.comparison-cell-media-container');

            videos.forEach((video, index) => {
                const container = containers[index];
                const img = container?.querySelector('.comparison-cell-media');

                if (video && container && img) {
                    // Unlock and return to hover behavior
                    container.dataset.locked = 'false';
                    video.style.removeProperty('opacity');
                    img.style.removeProperty('opacity');
                    video.pause();
                    video.currentTime = 0;
                }
            });

            showToast('Paused all videos', 'info');
        }

        function renderComparisonGrid() {
            const grid = document.getElementById('comparisonGrid');

            grid.innerHTML = comparisonItems.map((post, idx) => {
                const children = post.child_posts || post.children || [];
                const hasVideos = children.length > 0;
                const firstVideo = hasVideos ? children[0] : null;
                const mediaType = post.media_type || 'image';

                return `
                <div class="comparison-cell">
                    <div class="comparison-cell-media-container" id="compCell${idx}">
                        <img src="${post.local_file_path || post.media_url}"
                             alt="${post.prompt || 'Comparison item'}"
                             class="comparison-cell-media"
                             id="compImg${idx}"
                             onerror="this.src='${post.media_url}'">
                        ${firstVideo ? `
                        <video
                            class="comparison-cell-video"
                            id="compVid${idx}"
                            muted
                            loop
                            playsinline
                            preload="metadata"
                            src="${firstVideo.local_file_path || firstVideo.media_url}"
                            onmouseover="this.play()"
                            onmouseout="this.pause(); this.currentTime=0;">
                        </video>
                        ` : ''}
                        ${hasVideos ? `
                        <div class="comparison-video-badge">${children.length} video${children.length !== 1 ? 's' : ''}</div>
                        <button class="comparison-toggle-btn" onclick="toggleComparisonMedia(${idx}, event)" title="Toggle image/video">
                            🎬
                        </button>
                        ` : ''}
                    </div>
                    <div class="comparison-cell-info">
                        <div class="comparison-cell-prompt">${post.prompt || 'No prompt'}</div>
                        <div class="comparison-cell-meta">
                            <span>${post.model_name || 'Unknown'}</span>
                            <span>${new Date(post.create_time).toLocaleDateString()}</span>
                            <span>${mediaType}</span>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function toggleComparisonMedia(index, event) {
            event?.stopPropagation();
            const container = document.getElementById(`compCell${index}`);
            const video = document.getElementById(`compVid${index}`);
            const img = document.getElementById(`compImg${index}`);

            if (!container || !video || !img) return;

            // Toggle lock state
            const isLocked = container.dataset.locked === 'true';
            container.dataset.locked = (!isLocked).toString();

            if (!isLocked) {
                // Lock video visible - use !important to override hover
                video.style.setProperty('opacity', '1', 'important');
                img.style.setProperty('opacity', '0', 'important');
                video.play();
            } else {
                // Unlock, return to hover behavior - remove inline styles
                video.style.removeProperty('opacity');
                img.style.removeProperty('opacity');
                video.pause();
                video.currentTime = 0;
            }
        }

        function renderComparisonTable() {
            const table = document.getElementById('comparisonTable');

            // Extract metadata for comparison
            const rows = [
                { label: 'Model', values: comparisonItems.map(p => p.model_name || 'Unknown') },
                { label: 'Prompt', values: comparisonItems.map(p => p.prompt || 'N/A') },
                { label: 'Original Prompt', values: comparisonItems.map(p => p.original_prompt || 'N/A') },
                { label: 'Created', values: comparisonItems.map(p => new Date(p.create_time).toLocaleString()) },
                { label: 'Media Type', values: comparisonItems.map(p => p.media_type || 'Unknown') },
                { label: 'Video Count', values: comparisonItems.map(p => (p.child_posts || p.children || []).length) }
            ];

            table.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Property</th>
                            ${comparisonItems.map((_, i) => `<th>Item ${i + 1}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${rows.map(row => {
                            // Check if all values are the same
                            const allSame = row.values.every(v => v === row.values[0]);
                            return `
                                <tr>
                                    <td><strong>${row.label}</strong></td>
                                    ${row.values.map(value => `
                                        <td class="${!allSame ? 'highlight' : ''}">${value}</td>
                                    `).join('')}
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // ===== COLLECTIONS FUNCTIONALITY =====

        async function loadCollections() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/collections`);
                if (!response.ok) throw new Error('Failed to load collections');

                allCollections = await response.json();
                renderCollections();
            } catch (error) {
                console.error('Error loading collections:', error);
                document.getElementById('collectionsList').innerHTML =
                    '<div class="empty">Failed to load collections</div>';
            }
        }

        function renderCollections() {
            const listContainer = document.getElementById('collectionsList');

            if (allCollections.length === 0) {
                listContainer.innerHTML = '<div class="empty">No collections yet. Create one to get started!</div>';
                return;
            }

            listContainer.innerHTML = allCollections.map(collection => `
                <div class="collection-item" onclick="viewCollection('${collection.id}')">
                    <div class="collection-item-header">
                        <div class="collection-item-name">${collection.name}</div>
                        ${collection.is_smart ?
                            '<span class="collection-item-badge">Smart</span>' : ''}
                    </div>
                    ${collection.description ?
                        `<div class="collection-item-description">${collection.description}</div>` : ''}
                    <div class="collection-item-meta">
                        <span>${collection.item_count || 0} items</span>
                        <div class="collection-item-actions" onclick="event.stopPropagation()">
                            <button class="icon-btn" onclick="editCollection('${collection.id}')" title="Edit">
                                ✏️
                            </button>
                            <button class="icon-btn delete" onclick="deleteCollection('${collection.id}')" title="Delete">
                                🗑️
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleCollectionsSidebar() {
            const sidebar = document.getElementById('collectionsSidebar');
            sidebar.classList.toggle('open');

            // Load collections when opening
            if (sidebar.classList.contains('open')) {
                loadCollections();
            }
        }

        function openCollectionModal(collectionId = null) {
            currentEditingCollectionId = collectionId;
            const modal = document.getElementById('collectionModal');
            const titleEl = document.getElementById('collectionModalTitle');
            const form = document.getElementById('collectionForm');

            // Reset form
            form.reset();
            document.getElementById('smartFilters').classList.remove('visible');

            if (collectionId) {
                // Edit mode
                titleEl.textContent = 'Edit Collection';
                const collection = allCollections.find(c => c.id === collectionId);

                if (collection) {
                    document.getElementById('collectionName').value = collection.name;
                    document.getElementById('collectionDescription').value = collection.description || '';
                    document.getElementById('isSmartCollection').checked = collection.is_smart;

                    if (collection.is_smart && collection.smart_filters) {
                        document.getElementById('smartFilters').classList.add('visible');
                        document.getElementById('smartModel').value = collection.smart_filters.model || 'all';
                        document.getElementById('smartMode').value = collection.smart_filters.mode || 'all';
                        document.getElementById('smartSearch').value = collection.smart_filters.search || '';
                        previewSmartCollection();
                    }
                }
            } else {
                // Create mode
                titleEl.textContent = 'New Collection';

                // Populate model dropdown
                populateModelDropdown();
            }

            modal.classList.add('active');
        }

        function closeCollectionModal() {
            document.getElementById('collectionModal').classList.remove('active');
            currentEditingCollectionId = null;
        }

        function toggleSmartFilters() {
            const filtersDiv = document.getElementById('smartFilters');
            const checkbox = document.getElementById('isSmartCollection');

            if (checkbox.checked) {
                filtersDiv.classList.add('visible');
                populateModelDropdown();
                previewSmartCollection();
            } else {
                filtersDiv.classList.remove('visible');
            }
        }

        function populateModelDropdown() {
            const select = document.getElementById('smartModel');

            // Keep "All Models" option and add from existing filter
            const modelSelect = document.getElementById('modelFilter');
            const options = Array.from(modelSelect.options).map(opt => opt.value);

            select.innerHTML = options.map(value =>
                `<option value="${value}">${value === 'all' ? 'All Models' : value}</option>`
            ).join('');
        }

        let previewTimeout = null;

        async function previewSmartCollection() {
            clearTimeout(previewTimeout);

            previewTimeout = setTimeout(async () => {
                const previewDiv = document.getElementById('smartPreview');
                const model = document.getElementById('smartModel').value;
                const mode = document.getElementById('smartMode').value;
                const search = document.getElementById('smartSearch').value;

                previewDiv.innerHTML = '<div class="similar-items-loading">Loading preview...</div>';

                try {
                    const params = new URLSearchParams({
                        limit: '10'
                    });

                    if (model && model !== 'all') params.append('model', model);
                    if (mode && mode !== 'all') params.append('mode', mode);
                    if (search) params.append('search', search);

                    const response = await fetch(`${API_BASE_URL}/api/collections/smart/preview?${params}`);
                    if (!response.ok) throw new Error('Preview failed');

                    const posts = await response.json();

                    if (posts.length === 0) {
                        previewDiv.innerHTML = '<div class="similar-items-empty">No matching items</div>';
                    } else {
                        previewDiv.innerHTML = `
                            <div class="smart-preview-title">${posts.length} matching items</div>
                            <div class="smart-preview-items">
                                ${posts.slice(0, 8).map(post => `
                                    <img src="${post.local_file_path || post.media_url}"
                                         class="smart-preview-thumb"
                                         alt="${post.prompt || 'Preview'}">
                                `).join('')}
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Preview error:', error);
                    previewDiv.innerHTML = '<div class="similar-items-empty">Preview unavailable</div>';
                }
            }, 500); // Debounce
        }

        async function saveCollection(event) {
            event.preventDefault();

            const name = document.getElementById('collectionName').value;
            const description = document.getElementById('collectionDescription').value;
            const isSmartCollection = document.getElementById('isSmartCollection').checked;

            let smart_filters = null;
            if (isSmartCollection) {
                const model = document.getElementById('smartModel').value;
                const mode = document.getElementById('smartMode').value;
                const search = document.getElementById('smartSearch').value;

                smart_filters = {};
                if (model && model !== 'all') smart_filters.model = model;
                if (mode && mode !== 'all') smart_filters.mode = mode;
                if (search) smart_filters.search = search;
            }

            const collectionData = {
                name,
                description: description || null,
                is_smart: isSmartCollection,
                smart_filters
            };

            try {
                let response;

                if (currentEditingCollectionId) {
                    // Update existing collection
                    response = await fetch(
                        `${API_BASE_URL}/api/collections/${currentEditingCollectionId}`,
                        {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(collectionData)
                        }
                    );
                } else {
                    // Create new collection
                    response = await fetch(`${API_BASE_URL}/api/collections`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(collectionData)
                    });
                }

                if (!response.ok) throw new Error('Failed to save collection');

                const savedCollection = await response.json();

                SharedUtils.showToast(
                    currentEditingCollectionId ? 'Collection updated!' : 'Collection created!',
                    'success'
                );

                // If there's a pending post to add, add it now
                if (window.pendingCollectionPostId && !currentEditingCollectionId) {
                    await addToCollection(window.pendingCollectionPostId, savedCollection.id);
                    window.pendingCollectionPostId = null;
                }

                // If there's a pending bulk add, add selected items now
                if (window.bulkAddPending && !currentEditingCollectionId) {
                    window.bulkAddPending = false;
                    window.bulkCollectionResolve(savedCollection.id);
                }

                closeCollectionModal();
                loadCollections();
            } catch (error) {
                console.error('Error saving collection:', error);
                showToast('Failed to save collection', 'error');
            }
        }

        async function deleteCollection(collectionId) {
            if (!confirm('Are you sure you want to delete this collection?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/collections/${collectionId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete collection');

                showToast('Collection deleted', 'success');
                loadCollections();
            } catch (error) {
                console.error('Error deleting collection:', error);
                showToast('Failed to delete collection', 'error');
            }
        }

        function editCollection(collectionId) {
            openCollectionModal(collectionId);
        }

        async function viewCollection(collectionId) {
            // Close sidebar
            document.getElementById('collectionsSidebar').classList.remove('open');

            try {
                const response = await fetch(`${API_BASE_URL}/api/collections/${collectionId}`);
                if (!response.ok) throw new Error('Failed to load collection');

                const collection = await response.json();

                // Set filtered posts to collection items
                filteredPosts = collection.items || [];
                allPosts = [...filteredPosts];
                currentPage = 0;
                hasMorePosts = false;

                renderGallery();
                showToast(`Viewing collection: ${collection.name}`, 'success');
            } catch (error) {
                console.error('Error viewing collection:', error);
                showToast('Failed to load collection', 'error');
            }
        }

        async function addToCollection(postId, collectionId) {
            try {
                const response = await fetch(
                    `${API_BASE_URL}/api/collections/${collectionId}/items?media_post_id=${postId}`,
                    { method: 'POST' }
                );

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to add item');
                }

                SharedUtils.showToast('Added to collection', 'success');
                loadCollections(); // Refresh counts
                updateCollectionBadges(postId);
            } catch (error) {
                console.error('Error adding to collection:', error);
                SharedUtils.showToast(error.message || 'Failed to add to collection', 'error');
            }
        }

        async function removeFromCollection(postId, collectionId) {
            try {
                const response = await fetch(
                    `${API_BASE_URL}/api/collections/${collectionId}/items?media_post_id=${postId}`,
                    { method: 'DELETE' }
                );

                if (!response.ok) {
                    throw new Error('Failed to remove item');
                }

                SharedUtils.showToast('Removed from collection', 'success');
                loadCollections();
                updateCollectionBadges(postId);
            } catch (error) {
                console.error('Error removing from collection:', error);
                SharedUtils.showToast('Failed to remove from collection', 'error');
            }
        }

        // Collection dropdown management
        let currentOpenDropdown = null;

        async function toggleCollectionDropdown(postId, event) {
            event.stopPropagation();
            event.preventDefault();

            const dropdown = document.getElementById(`dropdown-${postId}`);

            // Close any other open dropdown
            if (currentOpenDropdown && currentOpenDropdown !== dropdown) {
                currentOpenDropdown.classList.remove('active');
            }

            // Toggle current dropdown
            const isOpen = dropdown.classList.toggle('active');
            currentOpenDropdown = isOpen ? dropdown : null;

            if (isOpen) {
                await populateCollectionDropdown(postId, dropdown);
            }
        }

        async function toggleModalCollectionDropdown(event) {
            event.stopPropagation();
            event.preventDefault();

            const dropdown = document.getElementById('modal-collection-dropdown');

            // Get current post from modal
            if (currentModalIndex === null || !filteredPosts[currentModalIndex]) {
                console.error('No post currently displayed in modal');
                return;
            }

            const currentPost = filteredPosts[currentModalIndex];
            const postId = currentPost.id;

            // Close any other open dropdown
            if (currentOpenDropdown && currentOpenDropdown !== dropdown) {
                currentOpenDropdown.classList.remove('active');
            }

            // Toggle current dropdown
            const isOpen = dropdown.classList.toggle('active');
            currentOpenDropdown = isOpen ? dropdown : null;

            if (isOpen) {
                await populateCollectionDropdown(postId, dropdown);
            }
        }

        async function populateCollectionDropdown(postId, dropdown) {
            try {
                // Get item's current collections
                const itemResponse = await fetch(`${API_BASE_URL}/api/media/${postId}/collections`);
                const itemCollections = itemResponse.ok ? await itemResponse.json() : [];
                const collectionIds = new Set(itemCollections.map(c => c.id));

                if (allCollections.length === 0) {
                    dropdown.innerHTML = `
                        <div class="collection-dropdown-empty">
                            No collections yet
                        </div>
                        <div class="collection-dropdown-item new-collection" onclick="createNewCollectionForItem('${postId}', event)">
                            ➕ Create Collection
                        </div>
                    `;
                    return;
                }

                dropdown.innerHTML = allCollections.map(collection => {
                    const isInCollection = collectionIds.has(collection.id);
                    return `
                        <div class="collection-dropdown-item ${isInCollection ? 'in-collection' : ''}"
                             onclick="toggleItemInCollection('${postId}', '${collection.id}', ${isInCollection}, event)">
                            <span>${isInCollection ? '✓' : ''}</span>
                            <span>${SharedUtils.escapeHtml(collection.name)}</span>
                            <span style="margin-left: auto; opacity: 0.6; font-size: 0.75rem;">${collection.item_count || 0}</span>
                        </div>
                    `;
                }).join('') + `
                    <div class="collection-dropdown-item new-collection" onclick="createNewCollectionForItem('${postId}', event)">
                        ➕ Create Collection
                    </div>
                `;

                // Update badge count
                updateCollectionCount(postId, itemCollections.length);
            } catch (error) {
                console.error('Error loading collections for dropdown:', error);
                dropdown.innerHTML = '<div class="collection-dropdown-empty">Error loading collections</div>';
            }
        }

        async function toggleItemInCollection(postId, collectionId, isInCollection, event) {
            event.stopPropagation();

            if (isInCollection) {
                await removeFromCollection(postId, collectionId);
            } else {
                await addToCollection(postId, collectionId);
            }

            // Refresh dropdown
            const dropdown = document.getElementById(`dropdown-${postId}`);
            await populateCollectionDropdown(postId, dropdown);
        }

        function createNewCollectionForItem(postId, event) {
            event.stopPropagation();

            // Close dropdown
            if (currentOpenDropdown) {
                currentOpenDropdown.classList.remove('active');
                currentOpenDropdown = null;
            }

            // Store post ID for adding after creation
            window.pendingCollectionPostId = postId;

            // Open collection modal
            openCollectionModal();
        }

        function updateCollectionCount(postId, count) {
            const countElement = document.getElementById(`collection-count-${postId}`);
            if (countElement) {
                countElement.textContent = count > 0 ? count : '';
            }
        }

        async function updateCollectionBadges(postId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/media/${postId}/collections`);
                if (response.ok) {
                    const collections = await response.json();
                    updateCollectionCount(postId, collections.length);
                }
            } catch (error) {
                console.error('Error updating collection badges:', error);
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (event) => {
            if (currentOpenDropdown && !event.target.closest('.add-to-collection-btn')) {
                currentOpenDropdown.classList.remove('active');
                currentOpenDropdown = null;
            }
        });

        // Initialize collection badges for all loaded posts
        async function initializeCollectionBadges() {
            const posts = filteredPosts.slice(0, 50); // Limit to first 50 for performance
            for (const post of posts) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/media/${post.id}/collections`);
                    if (response.ok) {
                        const collections = await response.json();
                        updateCollectionCount(post.id, collections.length);
                    }
                } catch (error) {
                    // Silently fail for individual posts
                }
            }
        }

        // Bulk add selected items to collection
        async function bulkAddToCollection() {
            if (comparisonItems.length === 0) {
                SharedUtils.showToast('No items selected', 'error');
                return;
            }

            // Show collection selection modal
            const collectionId = await showCollectionSelectionModal();
            if (!collectionId) return;

            // Add all selected items to the collection
            let successCount = 0;
            let errorCount = 0;

            for (const post of comparisonItems) {
                try {
                    const response = await fetch(
                        `${API_BASE_URL}/api/collections/${collectionId}/items?media_post_id=${post.id}`,
                        { method: 'POST' }
                    );

                    if (response.ok) {
                        successCount++;
                        updateCollectionBadges(post.id);
                    } else {
                        const error = await response.json();
                        if (error.detail && !error.detail.includes('already in collection')) {
                            errorCount++;
                        }
                    }
                } catch (error) {
                    console.error(`Error adding ${post.id} to collection:`, error);
                    errorCount++;
                }
            }

            // Show result
            if (successCount > 0) {
                SharedUtils.showToast(`Added ${successCount} item${successCount !== 1 ? 's' : ''} to collection`, 'success');
                loadCollections(); // Refresh collection counts
            }
            if (errorCount > 0) {
                SharedUtils.showToast(`Failed to add ${errorCount} item${errorCount !== 1 ? 's' : ''}`, 'error');
            }

            // Clear selection
            clearComparison();
        }

        // Show modal to select a collection for bulk add
        function showCollectionSelectionModal() {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'preset-modal active';
                modal.innerHTML = `
                    <div class="preset-modal-content preset-modal-small">
                        <div class="preset-modal-header">
                            <div class="preset-modal-title">Select Collection</div>
                            <button class="modal-close" onclick="this.closest('.preset-modal').remove(); return false;">×</button>
                        </div>
                        <div class="preset-list" id="bulkCollectionList">
                            ${allCollections.length === 0 ?
                                '<div class="preset-item">No collections available</div>' :
                                allCollections.map(collection => `
                                    <div class="preset-item" onclick="window.bulkCollectionResolve('${collection.id}'); this.closest('.preset-modal').remove();">
                                        <span>${SharedUtils.escapeHtml(collection.name)}</span>
                                        <span style="opacity: 0.6; font-size: 0.85rem;">${collection.item_count || 0} items</span>
                                    </div>
                                `).join('')
                            }
                        </div>
                        <div class="preset-modal-actions">
                            <button class="btn-secondary" onclick="this.closest('.preset-modal').remove(); window.bulkCollectionResolve(null);">Cancel</button>
                            <button class="btn-primary" onclick="window.createNewCollectionForBulk(); this.closest('.preset-modal').remove();">+ New Collection</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Store resolve function globally so modal can access it
                window.bulkCollectionResolve = resolve;

                // Close on outside click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(null);
                    }
                });
            });
        }

        // Create new collection for bulk add
        window.createNewCollectionForBulk = function() {
            window.bulkAddPending = true;
            openCollectionModal();
        };

        let removeFocusTrap = null;

        function openModal(index) {
            currentModalIndex = index;

            // Auto-switch to video mode if videos exist
            const post = filteredPosts[index];
            const children = post.child_posts || post.children || [];
            currentMode = children.length > 0 ? 'video' : 'image';
            currentVideoIndex = 0;

            const modal = document.getElementById('modal');
            modal.classList.add('active');

            renderModalContent();

            // Prevent body scroll
            document.body.style.overflow = 'hidden';

            // Setup focus trap
            setTimeout(() => {
                removeFocusTrap = trapFocus(modal);
            }, 100);
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.remove('active');

            // Re-enable body scroll
            document.body.style.overflow = 'auto';

            // Remove focus trap
            if (removeFocusTrap) {
                removeFocusTrap();
                removeFocusTrap = null;
            }
        }

        function navigatePost(direction) {
            currentModalIndex += direction;

            if (currentModalIndex < 0) {
                currentModalIndex = filteredPosts.length - 1;
            } else if (currentModalIndex >= filteredPosts.length) {
                currentModalIndex = 0;
            }

            currentVideoIndex = 0;
            renderModalContent();
        }

        function navigateInModal(direction) {
            const post = filteredPosts[currentModalIndex];
            const children = post.child_posts || post.children || [];

            // If in video mode and has videos
            if (currentMode === 'video' && children.length > 0) {
                const newVideoIndex = currentVideoIndex + direction;

                // If still within video range, navigate videos
                if (newVideoIndex >= 0 && newVideoIndex < children.length) {
                    currentVideoIndex = newVideoIndex;
                    renderModalContent();
                    return;
                }

                // Reached end of videos, move to next post
                if (newVideoIndex >= children.length) {
                    // Move to next post
                    currentModalIndex++;
                    if (currentModalIndex >= filteredPosts.length) {
                        currentModalIndex = 0;
                    }
                    currentVideoIndex = 0;
                    renderModalContent();
                    return;
                }

                // Before first video, move to previous post
                if (newVideoIndex < 0) {
                    currentModalIndex--;
                    if (currentModalIndex < 0) {
                        currentModalIndex = filteredPosts.length - 1;
                    }
                    // Go to last video of previous post
                    const prevPost = filteredPosts[currentModalIndex];
                    const prevChildren = prevPost.child_posts || prevPost.children || [];
                    if (prevChildren.length > 0) {
                        currentVideoIndex = prevChildren.length - 1;
                        currentMode = 'video';
                    } else {
                        currentVideoIndex = 0;
                        currentMode = 'image';
                    }
                    renderModalContent();
                    return;
                }
            }

            // Image mode or no videos - navigate posts
            navigatePost(direction);
        }

        function setMode(mode) {
            currentMode = mode;
            currentVideoIndex = 0;

            // Update button states and aria-pressed
            document.querySelectorAll('.mode-btn').forEach(btn => {
                const isActive = btn.dataset.mode === mode;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-pressed', isActive.toString());
            });

            renderModalContent();
        }

        async function generateVideoFromImage() {
            const post = filteredPosts[currentModalIndex];
            // Check if media type is image (handles both "image" and "MEDIA_POST_TYPE_IMAGE")
            const isImage = post && (post.media_type === 'image' || post.media_type.includes('IMAGE'));
            if (!isImage) {
                showToast('Can only generate videos from images', 'error');
                return;
            }

            const btn = document.getElementById('generateVideoBtn');
            const modelSelector = document.getElementById('modelSelector');
            const selectedModel = modelSelector ? modelSelector.value : 'wan';
            const originalText = btn.innerHTML;

            // Model-specific settings
            const modelSettings = {
                wan: {
                    num_frames: 49,
                    fps: 16,
                    time: '3-5 min',
                    name: 'Wan 2.1'
                },
                svd: {
                    num_frames: 14,
                    fps: 7,
                    time: '1-2 min',
                    name: 'SVD'
                }
            };

            const settings = modelSettings[selectedModel] || modelSettings.wan;

            try {
                // Disable button and show generating state
                btn.disabled = true;
                btn.classList.add('generating');
                btn.innerHTML = `⏳ Generating... (${settings.time})`;

                showToast(`Starting video generation with ${settings.name}... This may take ${settings.time}`, 'info');

                // Call API to generate video with model-specific parameters
                const params = new URLSearchParams({
                    model: selectedModel,
                    num_frames: settings.num_frames,
                    fps: settings.fps,
                    prompt: '',             // Optional text guidance
                    guidance_scale: 5.0     // How closely to follow prompt
                });

                const response = await fetch(`${API_BASE_URL}/api/media/${post.id}/generate-video?${params}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Generation failed');
                }

                const result = await response.json();

                showToast('Video generated successfully!', 'success');

                // Reload the post to get the new child video
                await loadPosts();

                // Re-render modal to show new video
                renderModalContent();

                // Auto-switch to video mode to show the new video
                setTimeout(() => {
                    setMode('video');
                }, 500);

            } catch (error) {
                console.error('Video generation error:', error);
                showToast(`Failed to generate video: ${error.message}`, 'error');
            } finally {
                // Re-enable button
                btn.disabled = false;
                btn.classList.remove('generating');
                btn.innerHTML = originalText;
            }
        }

        function setVideoIteration(index) {
            currentVideoIndex = index;
            renderModalContent();
        }

        function renderModalContent() {
            const post = filteredPosts[currentModalIndex];
            const mediaContainer = document.getElementById('modalMedia');
            const promptContainer = document.getElementById('modalPrompt');
            const dotsContainer = document.getElementById('iterationDots');
            const counterContainer = document.getElementById('postCounter');
            const children = post.child_posts || post.children || [];
            const hasVideos = children.length > 0;

            // Load similar items for this post
            if (post.id) {
                loadSimilarItems(post.id);
            }

            // Load saved model preference
            loadModelPreference();

            // Update prompt - show child's custom prompt if in video mode with custom mode
            let displayPrompt = post.prompt;
            if (currentMode === 'video' && hasVideos) {
                const currentChild = children[currentVideoIndex];
                if (currentChild && currentChild.mode === 'custom' && currentChild.original_prompt) {
                    displayPrompt = currentChild.original_prompt;
                }
            }
            promptContainer.textContent = displayPrompt;

            // Update counter
            counterContainer.textContent = `${currentModalIndex + 1} / ${filteredPosts.length}`;

            // Show/hide video button based on availability
            const videoBtn = document.querySelector('.mode-btn[data-mode="video"]');
            if (videoBtn) {
                if (hasVideos) {
                    videoBtn.style.display = 'flex';
                    videoBtn.querySelector('span')?.remove();
                    const count = document.createElement('span');
                    count.style.cssText = 'opacity: 0.7; font-size: 0.85em;';
                    count.textContent = `(${children.length})`;
                    videoBtn.appendChild(count);
                } else {
                    videoBtn.style.display = 'none';
                    // Switch to image mode if we're in video mode but no videos available
                    if (currentMode === 'video') {
                        currentMode = 'image';
                        document.querySelectorAll('.mode-btn').forEach(btn => {
                            const isActive = btn.dataset.mode === 'image';
                            btn.classList.toggle('active', isActive);
                            btn.setAttribute('aria-pressed', isActive.toString());
                        });
                    }
                }
            }

            // Always show generate video section, but disable for non-images
            const generateVideoSection = document.getElementById('generateVideoSection');
            const generateVideoBtn = document.getElementById('generateVideoBtn');
            if (generateVideoSection && generateVideoBtn) {
                const isImage = post.media_type === 'image' || post.media_type.includes('IMAGE');
                generateVideoSection.style.display = 'flex';  // Always visible
                if (!isImage) {
                    generateVideoBtn.disabled = true;
                    generateVideoBtn.title = 'Only images can generate videos';
                    generateVideoBtn.style.opacity = '0.5';
                    generateVideoBtn.style.cursor = 'not-allowed';
                } else {
                    generateVideoBtn.disabled = false;
                    generateVideoBtn.title = 'Generate video from this image';
                    generateVideoBtn.style.opacity = '1';
                    generateVideoBtn.style.cursor = 'pointer';
                }
            }

            // Always show merge videos button, but disable when less than 2 videos
            const mergeVideosBtn = document.getElementById('mergeVideosBtn');
            if (mergeVideosBtn) {
                const hasEnoughVideos = hasVideos && children.length >= 2;
                mergeVideosBtn.style.display = 'flex';  // Always visible
                if (!hasEnoughVideos) {
                    mergeVideosBtn.disabled = true;
                    mergeVideosBtn.title = 'Need at least 2 videos to merge';
                    mergeVideosBtn.style.opacity = '0.5';
                    mergeVideosBtn.style.cursor = 'not-allowed';
                } else {
                    mergeVideosBtn.disabled = false;
                    mergeVideosBtn.title = 'Merge multiple videos with AI transitions';
                    mergeVideosBtn.style.opacity = '1';
                    mergeVideosBtn.style.cursor = 'pointer';
                }
            }

            // Render media
            if (currentMode === 'image') {
                mediaContainer.innerHTML = `
                    <img src="${post.local_file_path || post.media_url}"
                         alt="${post.prompt}"
                         onerror="this.src='${post.media_url}'">
                `;
                dotsContainer.innerHTML = '';
            } else {
                // Video mode
                const currentChild = children[currentVideoIndex];
                mediaContainer.innerHTML = `
                    <video controls autoplay loop>
                        <source src="${currentChild.local_file_path || currentChild.media_url}"
                                type="video/mp4"
                                onerror="this.src='${currentChild.media_url}'">
                    </video>
                `;

                // Render iteration dots
                dotsContainer.innerHTML = children.map((_, i) => `
                    <div class="dot ${i === currentVideoIndex ? 'active' : ''}"
                         onclick="setVideoIteration(${i})"></div>
                `).join('');
            }
        }

        function handleKeyboard(e) {
            // Don't trigger shortcuts if typing in input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }

            const modal = document.getElementById('modal');
            const comparisonModal = document.getElementById('comparisonModal');

            // Handle comparison modal shortcuts
            if (comparisonModal.classList.contains('active')) {
                switch(e.key) {
                    case 'Escape':
                        closeComparisonModal();
                        break;
                    case 'p':
                    case 'P':
                        playAllComparisonVideos();
                        break;
                    case 's':
                    case 'S':
                        pauseAllComparisonVideos();
                        break;
                    case '2':
                    case '3':
                    case '4':
                    case '5':
                    case '6':
                        document.getElementById('comparisonColumns').value = e.key;
                        updateComparisonColumns();
                        break;
                    case 'g':
                    case 'G':
                        setComparisonViewMode('grid');
                        break;
                    case 'm':
                    case 'M':
                        setComparisonViewMode('masonry');
                        break;
                }
                return;
            }

            // Handle main modal shortcuts
            if (modal.classList.contains('active')) {
                switch(e.key) {
                    case 'Escape':
                        closeModal();
                        break;
                    case 'ArrowLeft':
                        navigateInModal(-1);
                        break;
                    case 'ArrowRight':
                        navigateInModal(1);
                        break;
                    case 'i':
                    case 'I':
                        setMode('image');
                        break;
                    case 'v':
                    case 'V':
                        // Only switch to video mode if videos are available
                        const post = filteredPosts[currentModalIndex];
                        const children = post && (post.child_posts || post.children);
                        if (children && children.length > 0) {
                            setMode('video');
                        }
                        break;
                    case 'c':
                    case 'C':
                        // Open collection dropdown in modal
                        e.preventDefault();
                        const modalCollectionBtn = document.getElementById('modalCollectionBtn');
                        if (modalCollectionBtn) {
                            modalCollectionBtn.click();
                        }
                        break;
                }
                return;
            }

            // Global shortcuts (when no modal is open)
            switch(e.key) {
                case 'c':
                case 'C':
                    e.preventDefault();
                    // If items are selected, open bulk collection modal
                    if (comparisonItems.length > 0) {
                        bulkAddToCollection();
                    }
                    break;
            }
        }

        // ============================================
        // PROMPT LIBRARY FUNCTIONALITY
        // ============================================

        let promptLibraryData = {
            stats: null,
            prompts: [],
            isOpen: false
        };

        // Toggle Prompt Library
        function togglePromptLibrary() {
            const sidebar = document.getElementById('promptLibrarySidebar');
            const toggle = document.getElementById('promptLibraryToggle');

            promptLibraryData.isOpen = !promptLibraryData.isOpen;

            if (promptLibraryData.isOpen) {
                sidebar.classList.add('open');
                toggle.classList.add('active');
                loadPromptLibraryData();
            } else {
                sidebar.classList.remove('open');
                toggle.classList.remove('active');
            }
        }

        // Load Prompt Library Data
        async function loadPromptLibraryData() {
            try {
                // Load stats
                const statsResponse = await fetch(`${API_BASE_URL}/api/prompts/stats`);
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    promptLibraryData.stats = stats;

                    document.getElementById('totalPromptsCount').textContent = stats.total_unique_prompts || 0;
                    document.getElementById('customPromptsCount').textContent = stats.total_custom_prompts || 0;

                    // Display most used prompts
                    if (stats.most_used_prompts && stats.most_used_prompts.length > 0) {
                        renderMostUsedPrompts(stats.most_used_prompts);
                    }
                }

                // Load all prompts
                const promptsResponse = await fetch(`${API_BASE_URL}/api/prompts?limit=50&sort=recent`);
                if (promptsResponse.ok) {
                    const data = await promptsResponse.json();
                    promptLibraryData.prompts = data.prompts || [];
                    renderRecentPrompts(promptLibraryData.prompts.slice(0, 10));
                }
            } catch (error) {
                console.error('Error loading prompt library:', error);
                SharedUtils.showToast('Failed to load prompt library', 'error');
            }
        }

        // Render Most Used Prompts
        function renderMostUsedPrompts(prompts) {
            const container = document.getElementById('mostUsedPrompts');

            if (!prompts || prompts.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 1rem;">No prompts yet</div>';
                return;
            }

            container.innerHTML = prompts.map(item => `
                <div class="prompt-item" onclick="searchByPrompt('${escapeHtml(item.prompt)}')">
                    <div class="prompt-item-text">${escapeHtml(item.prompt)}</div>
                    <div class="prompt-item-meta">
                        <span>Used ${item.count} times</span>
                        <span>👁️ View</span>
                    </div>
                </div>
            `).join('');
        }

        // Render Recent Prompts
        function renderRecentPrompts(prompts) {
            const container = document.getElementById('recentPrompts');

            if (!prompts || prompts.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 1rem;">No prompts yet</div>';
                return;
            }

            container.innerHTML = prompts.map(item => `
                <div class="prompt-item" onclick="searchByPrompt('${escapeHtml(item.prompt)}')">
                    <div class="prompt-item-text">${escapeHtml(item.prompt)}</div>
                    <div class="prompt-item-meta">
                        <span>${item.usage_count} uses</span>
                        <span>${new Date(item.last_used).toLocaleDateString()}</span>
                    </div>
                </div>
            `).join('');
        }

        // Search Prompt Library
        let promptSearchTimeout;
        async function searchPromptLibrary(query) {
            clearTimeout(promptSearchTimeout);

            if (!query || query.trim().length < 2) {
                renderRecentPrompts(promptLibraryData.prompts.slice(0, 10));
                return;
            }

            promptSearchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/prompts/search?q=${encodeURIComponent(query)}`);
                    if (response.ok) {
                        const data = await response.json();
                        renderRecentPrompts(data.prompts || []);
                    }
                } catch (error) {
                    console.error('Error searching prompts:', error);
                }
            }, 300);
        }

        // Search by Prompt
        function searchByPrompt(prompt) {
            document.getElementById('searchInput').value = prompt;
            applyFilters();
            togglePromptLibrary();
            SharedUtils.showToast(`Filtering by: "${prompt.substring(0, 50)}..."`, 'success');
        }

        // ============================================
        // PROMPT STUDIO FUNCTIONALITY
        // ============================================

        function openPromptStudio(prefillPrompt) {
            document.getElementById('promptStudioModal').classList.add('active');
            if (prefillPrompt) {
                document.getElementById('basePromptInput').value = prefillPrompt;
                document.getElementById('promptCharCount').textContent = prefillPrompt.length;
            }
            document.getElementById('basePromptInput').focus();
        }

        function closePromptStudio() {
            document.getElementById('promptStudioModal').classList.remove('active');
            document.getElementById('basePromptInput').value = '';
            document.getElementById('generatedVariationsContainer').style.display = 'none';
            document.getElementById('generatedVariationsList').innerHTML = '';
            document.getElementById('promptCharCount').textContent = '0';
        }

        // Generate Prompt Variations
        async function generatePromptVariations() {
            const basePrompt = document.getElementById('basePromptInput').value.trim();
            const variationType = document.getElementById('variationType').value;
            const count = parseInt(document.getElementById('variationCount').value);
            const btn = document.getElementById('generateVariationsBtn');

            if (!basePrompt) {
                SharedUtils.showToast('Please enter a base prompt', 'error');
                return;
            }

            // Disable button and show loading
            btn.disabled = true;
            btn.innerHTML = '⏳ Generating...';

            try {
                const response = await fetch(`${API_BASE_URL}/api/prompts/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        base_prompt: basePrompt,
                        variation_type: variationType,
                        num_variations: count
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate variations');
                }

                const data = await response.json();

                // Display variations
                displayGeneratedVariations(data.variations || []);

                SharedUtils.showToast(`Generated ${count} variations!`, 'success');
            } catch (error) {
                console.error('Error generating prompts:', error);
                SharedUtils.showToast('Failed to generate variations. Make sure Ollama is running.', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '✨ Generate Variations';
            }
        }

        // Display Generated Variations
        function displayGeneratedVariations(variations) {
            const container = document.getElementById('generatedVariationsContainer');
            const list = document.getElementById('generatedVariationsList');

            if (!variations || variations.length === 0) {
                return;
            }

            container.style.display = 'block';

            list.innerHTML = variations.map((variation, index) => `
                <div class="prompt-variation-card">
                    <div class="prompt-variation-text">${escapeHtml(variation)}</div>
                    <div class="prompt-variation-actions">
                        <button class="prompt-variation-btn" onclick="usePromptVariation(\`${escapeHtml(variation)}\`)">
                            ✓ Use This
                        </button>
                        <button class="prompt-variation-btn" onclick="copyToClipboard(\`${escapeHtml(variation)}\`, event)">
                            📋 Copy
                        </button>
                        <button class="prompt-variation-btn" onclick="searchByPrompt(\`${escapeHtml(variation)}\`)">
                            🔍 Search
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Use Prompt Variation
        function usePromptVariation(prompt) {
            document.getElementById('basePromptInput').value = prompt;
            document.getElementById('promptCharCount').textContent = prompt.length;
            SharedUtils.showToast('Prompt updated! Generate more or close to use.', 'success');
        }

        // ============================================
        // KEYBOARD SHORTCUTS
        // ============================================

        document.addEventListener('keydown', (e) => {
            // Ignore if typing in an input field
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }

            switch(e.key.toLowerCase()) {
                case 'l':
                    e.preventDefault();
                    togglePromptLibrary();
                    break;
                case 'p':
                    e.preventDefault();
                    openPromptStudio();
                    break;
                case 's':
                    if (currentModalPost) {
                        e.preventDefault();
                        // Focus on similar items
                        document.getElementById('similarItems')?.scrollIntoView({ behavior: 'smooth' });
                    }
                    break;
            }
        });

        // ============================================
        // HELPER FUNCTIONS
        // ============================================

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // ENHANCED GALLERY CARD RENDERING
        // ============================================

        // This function should be called to enhance existing gallery cards
        function enhanceGalleryCardsWithPrompts() {
            const items = document.querySelectorAll('.gallery-item');

            items.forEach(item => {
                // Add Find Similar button if not already present
                const overlay = item.querySelector('.gallery-item-overlay .overlay-top');
                if (overlay && !overlay.querySelector('.quick-action-similar')) {
                    const similarBtn = document.createElement('button');
                    similarBtn.className = 'quick-action quick-action-similar';
                    similarBtn.setAttribute('aria-label', 'Find similar');
                    similarBtn.setAttribute('title', 'Find similar items (S)');
                    similarBtn.innerHTML = '👁️';
                    similarBtn.onclick = (e) => {
                        e.stopPropagation();
                        const postId = item.getAttribute('data-id');
                        openItemAndShowSimilar(postId);
                    };
                    overlay.appendChild(similarBtn);
                }

                // Add Prompt Studio button
                if (overlay && !overlay.querySelector('.quick-action-prompt-studio')) {
                    const studioBtn = document.createElement('button');
                    studioBtn.className = 'quick-action quick-action-prompt-studio';
                    studioBtn.setAttribute('aria-label', 'Generate variations');
                    studioBtn.setAttribute('title', 'Generate prompt variations (P)');
                    studioBtn.innerHTML = '✨';
                    studioBtn.onclick = (e) => {
                        e.stopPropagation();
                        const prompt = item.querySelector('.item-prompt')?.textContent;
                        if (prompt && prompt !== 'No prompt available') {
                            openPromptStudio(prompt);
                        } else {
                            openPromptStudio();
                        }
                    };
                    overlay.appendChild(studioBtn);
                }
            });
        }

        // Open item and show similar
        function openItemAndShowSimilar(postId) {
            const index = filteredPosts.findIndex(p => p.id === postId);
            if (index !== -1) {
                openModal(index);
                // Similar items will load automatically in openModal
            }
        }

        console.log('✨ 8xSovia UI Enhancements Loaded');
        console.log('Keyboard Shortcuts:');
        console.log('  L - Toggle Prompt Library');
        console.log('  P - Open Prompt Studio');
        console.log('  S - Focus Similar Items (in modal)');

        // Initialize on load
        init();

        // ===== VIDEO CHAINS FUNCTIONALITY =====

        function openVideoChainsModal() {
            document.getElementById('videoChainsModal').classList.add('active');
        }

        function closeVideoChainsModal() {
            document.getElementById('videoChainsModal').classList.remove('active');
        }

        async function analyzeAllVideos() {
            const statusDiv = document.getElementById('analysisStatus');
            const statusText = document.getElementById('analysisStatusText');
            const analyzeBtn = document.getElementById('analyzeBtn');

            try {
                statusDiv.style.display = 'block';
                statusText.textContent = 'Analyzing videos... This may take a few minutes.';
                analyzeBtn.disabled = true;

                const response = await fetch(`${API_BASE_URL}/api/analyze-videos`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('Failed to analyze videos');
                }

                const result = await response.json();

                statusText.textContent = `✅ Analysis complete! Processed ${result.processed} videos, updated ${result.updated} with frame hashes.`;

                if (result.errors && result.errors.length > 0) {
                    statusText.textContent += ` (${result.errors.length} errors)`;
                }

                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);

                showToast(`Successfully analyzed ${result.updated} videos`);

            } catch (error) {
                console.error('Analysis failed:', error);
                statusText.textContent = '❌ Analysis failed: ' + error.message;
                showToast('Failed to analyze videos', 'error');
            } finally {
                analyzeBtn.disabled = false;
            }
        }

        let currentChains = [];

        async function loadVideoChains() {
            const threshold = parseInt(document.getElementById('thresholdInput').value) || 10;
            const minLength = parseInt(document.getElementById('minChainLength').value) || 2;
            const loadBtn = document.getElementById('loadChainsBtn');

            try {
                loadBtn.disabled = true;
                loadBtn.textContent = '⏳ Loading...';

                const response = await fetch(`${API_BASE_URL}/api/video-chains?threshold=${threshold}&min_chain_length=${minLength}`);

                if (!response.ok) {
                    throw new Error('Failed to load video chains');
                }

                const result = await response.json();
                currentChains = result.chains;

                // Update stats
                document.getElementById('chainStats').style.display = 'block';
                document.getElementById('totalVideos').textContent = result.total_videos;
                document.getElementById('totalChains').textContent = result.total_chains;
                document.getElementById('longestChain').textContent =
                    result.chains.length > 0 ? `${result.chains[0].length} videos` : '0 videos';

                // Display chains
                displayVideoChains(result.chains);

                showToast(`Found ${result.total_chains} video chains`);

            } catch (error) {
                console.error('Failed to load chains:', error);
                showToast('Failed to load video chains', 'error');
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = '📊 Find Video Chains';
            }
        }

        function displayVideoChains(chains) {
            const chainsList = document.getElementById('chainsList');

            if (chains.length === 0) {
                chainsList.innerHTML = `
                    <div style="color: rgba(255,255,255,0.6); text-align: center; padding: 3rem;">
                        No video chains found. Try adjusting the match threshold or minimum chain length.
                    </div>
                `;
                return;
            }

            chainsList.innerHTML = chains.map((chain, index) => {
                const videosHtml = chain.videos.map((video, vidIndex) => `
                    <div style="display: flex; gap: 1rem; align-items: center; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 0.5rem;">
                        <div style="min-width: 30px; font-weight: bold; color: rgba(255,255,255,0.5);">${vidIndex + 1}.</div>
                        <video src="${API_BASE_URL}/media/${video.media_url}"
                               style="width: 120px; height: 68px; object-fit: cover; border-radius: 4px;"
                               muted></video>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 0.9rem; font-weight: 500; margin-bottom: 0.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${video.prompt || 'No prompt'}
                            </div>
                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.5);">
                                ${video.id.substring(0, 8)}... • ${video.type}
                            </div>
                        </div>
                        ${vidIndex < chain.videos.length - 1 ? '<div style="font-size: 1.5rem; color: rgba(255,255,255,0.3);">→</div>' : ''}
                    </div>
                `).join('');

                return `
                    <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; border: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 0.25rem;">
                                    Chain #${index + 1}
                                    <span style="color: rgba(255,255,255,0.6); font-size: 0.9rem;">(${chain.length} videos)</span>
                                </div>
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.5);">
                                    ~${chain.total_duration_estimate} seconds total duration
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn-primary" onclick="previewChain(${index})" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                                    ▶️ Preview
                                </button>
                                <button class="btn-primary" onclick="mergeChain(${index}, false)" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                                    🔗 Merge
                                </button>
                                <button class="btn-primary" onclick="mergeChain(${index}, true)" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                                    ✨ Merge (Smooth)
                                </button>
                            </div>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${videosHtml}
                        </div>
                    </div>
                `;
            }).join('');

            // Add hover preview to videos
            setTimeout(() => {
                const videos = chainsList.querySelectorAll('video');
                videos.forEach(video => {
                    video.addEventListener('mouseenter', () => {
                        video.currentTime = 0;
                        video.play().catch(e => console.log('Preview play failed:', e));
                    });
                    video.addEventListener('mouseleave', () => {
                        video.pause();
                    });
                });
            }, 100);
        }

        function previewChain(chainIndex) {
            const chain = currentChains[chainIndex];
            if (!chain || chain.videos.length === 0) return;

            // Open the first video in the modal
            const firstVideoId = chain.videos[0].id;
            const postIndex = filteredPosts.findIndex(p => p.id === firstVideoId);

            if (postIndex !== -1) {
                openModal(postIndex);
                showToast(`Previewing chain #${chainIndex + 1} (${chain.length} videos)`);
            } else {
                showToast('Video not found in current gallery view', 'error');
            }
        }

        async function mergeChain(chainIndex, useTransitions) {
            const chain = currentChains[chainIndex];
            if (!chain || chain.videos.length < 2) {
                showToast('Need at least 2 videos to merge', 'error');
                return;
            }

            const videoIds = chain.videos.map(v => v.id);

            try {
                showToast(`Merging ${chain.length} videos... This may take a while.`);

                const response = await fetch(`${API_BASE_URL}/api/merge-chain`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chain_video_ids: videoIds,
                        use_transitions: useTransitions
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to merge videos');
                }

                const result = await response.json();

                showToast(`✅ Successfully merged ${result.chain_length} videos!`);

                // Reload gallery to show new merged video
                setTimeout(() => {
                    location.reload();
                }, 2000);

            } catch (error) {
                console.error('Merge failed:', error);
                showToast('Failed to merge videos: ' + error.message, 'error');
            }
        }
    </script>

    <!-- Prompt Library Toggle Button -->
    <button class="prompt-library-toggle" id="promptLibraryToggle" onclick="togglePromptLibrary()" title="Open Prompt Library (Keyboard: L)">
        📚 PROMPT LIBRARY
    </button>

    <!-- Prompt Library Sidebar -->
    <div class="prompt-library-sidebar" id="promptLibrarySidebar">
        <div class="prompt-library-header">
            <div class="prompt-library-title">
                📚 Prompt Library
            </div>
            <button class="prompt-library-close" onclick="togglePromptLibrary()">×</button>
        </div>

        <div class="prompt-library-content">
            <!-- Search Box -->
            <div class="prompt-search-box">
                <span class="prompt-search-icon">🔍</span>
                <input type="text" class="prompt-search-input" id="promptLibrarySearch"
                       placeholder="Search prompts..." onkeyup="searchPromptLibrary(this.value)">
            </div>

            <!-- Stats -->
            <div class="prompt-stats-grid" id="promptStatsGrid">
                <div class="prompt-stat-card">
                    <div class="prompt-stat-value" id="totalPromptsCount">-</div>
                    <div class="prompt-stat-label">Total Prompts</div>
                </div>
                <div class="prompt-stat-card">
                    <div class="prompt-stat-value" id="customPromptsCount">-</div>
                    <div class="prompt-stat-label">Custom</div>
                </div>
            </div>

            <!-- Generate Button -->
            <button class="prompt-generate-btn" onclick="openPromptStudio()">
                ✨ Generate New Prompts
            </button>

            <!-- Most Used Prompts -->
            <div class="prompt-section">
                <div class="prompt-section-header">
                    <div class="prompt-section-title">📊 Most Used</div>
                </div>
                <div id="mostUsedPrompts">
                    <div style="text-align: center; color: rgba(255,255,255,0.5); padding: 2rem;">
                        Loading...
                    </div>
                </div>
            </div>

            <!-- Recent Prompts -->
            <div class="prompt-section">
                <div class="prompt-section-header">
                    <div class="prompt-section-title">⏱️ Recently Used</div>
                </div>
                <div id="recentPrompts">
                    <div style="text-align: center; color: rgba(255,255,255,0.5); padding: 2rem;">
                        Loading...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Prompt Studio Modal -->
    <div class="prompt-studio-modal" id="promptStudioModal">
        <div class="prompt-studio-content">
            <div class="prompt-studio-header">
                <div class="prompt-studio-title">
                    ✨ Prompt Studio
                </div>
                <button class="prompt-library-close" onclick="closePromptStudio()">×</button>
            </div>

            <div class="prompt-studio-body">
                <!-- Base Prompt Input -->
                <div class="prompt-input-section">
                    <label class="prompt-input-label" for="basePromptInput">
                        Base Prompt <span class="keyboard-shortcut-hint">Required</span>
                    </label>
                    <textarea class="prompt-input-textarea" id="basePromptInput"
                              placeholder="Enter your base prompt here... (e.g., 'a cyberpunk city at night')"
                              oninput="document.getElementById('promptCharCount').textContent = this.value.length"></textarea>
                    <div style="text-align: right; font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-top: 0.25rem;">
                        <span id="promptCharCount">0</span> characters
                    </div>
                </div>

                <!-- Options -->
                <div class="prompt-options-grid">
                    <div class="prompt-option-group">
                        <label class="prompt-input-label">Variation Type</label>
                        <select id="variationType" style="padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; font-size: 0.9rem;">
                            <option value="creative">Creative</option>
                            <option value="technical">Technical</option>
                            <option value="style">Style Variations</option>
                            <option value="mood">Mood Variations</option>
                        </select>
                    </div>
                    <div class="prompt-option-group">
                        <label class="prompt-input-label">
                            Number of Variations: <span id="variationCountLabel">5</span>
                        </label>
                        <input type="range" id="variationCount" min="1" max="10" value="5"
                               oninput="document.getElementById('variationCountLabel').textContent = this.value"
                               style="width: 100%;">
                    </div>
                </div>

                <!-- Generate Button -->
                <button class="prompt-generate-btn" onclick="generatePromptVariations()" id="generateVariationsBtn">
                    ✨ Generate Variations
                </button>

                <!-- Generated Variations -->
                <div class="prompt-variations-container" id="generatedVariationsContainer" style="display: none;">
                    <div class="prompt-variations-header">
                        💡 Generated Variations
                    </div>
                    <div id="generatedVariationsList"></div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
